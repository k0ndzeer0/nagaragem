<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Na Garagem - Painel Administrativo</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configuração do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cores Semânticas (Mapeadas para Variáveis CSS)
                        main: 'var(--bg-main)',
                        card: 'var(--bg-card)',
                        element: 'var(--bg-element)',
                        'text-main': 'var(--text-main)',
                        'text-muted': 'var(--text-muted)',
                        'border-main': 'var(--border-main)',
                        
                        brand: {
                            red: "#B11226",
                        }
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        display: ["Oswald", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <style>
        /* Tema Escuro (Padrão) */
        :root {
            --bg-main: #0B0B0B;
            --bg-card: #121212;
            --bg-element: #1F1F1F;
            --text-main: #F5F5F5;
            --text-muted: #9CA3AF; /* gray-400 */
            --border-main: #1F2937; /* gray-800 */
        }

        /* Tema Claro */
        .light {
            --bg-main: #F3F4F6; /* gray-100 */
            --bg-card: #FFFFFF;
            --bg-element: #E5E7EB; /* gray-200 */
            --text-main: #111827; /* gray-900 */
            --text-muted: #4B5563; /* gray-600 */
            --border-main: #D1D5DB; /* gray-300 */
        }

        body { background-color: var(--bg-main); color: var(--text-main); min-height: 100vh; transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #B11226; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @media print {
            body { background: white !important; color: black !important; }
            nav, button { display: none !important; }
            .bg-card, .bg-element { background: white !important; border: 1px solid #ccc !important; color: black !important; }
            .text-white { color: black !important; }
            .text-gray-400 { color: #333 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useMemo } = React;

        // --- CONFIGURAÇÃO SUPABASE ---
        const supabaseUrl = 'https://zgeyjrmnkisomdlugupm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnZXlqcm1ua2lzb21kbHVndXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDU5MjEsImV4cCI6MjA4NDg4MTkyMX0.UK5O__2vwehjEQYGaPW3E2rPZZkiTFtXoWNJVKnmoLQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- ÍCONES SVG ---
        const Icons = {
            Dashboard: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Menu: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Image: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            Star: ({filled}) => <svg width="20" height="20" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            Copy: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Logout: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            List: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Printer: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>,
            History: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>,
            Kanban: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>,
            Sun: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Moon: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Users: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            Percent: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>,
            Dollar: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        };

        // --- TOAST CONTEXT ---
        const ToastContext = createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 4000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none items-end">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`pointer-events-auto w-full max-w-sm p-4 rounded shadow-2xl text-white flex justify-between items-center transform transition-all duration-300 animate-fade-in ${
                                toast.type === 'error' ? 'bg-[#B11226] border border-red-800' : 'bg-green-700 border border-green-600'
                            }`}>
                                <div className="flex items-center gap-3">
                                    {toast.type === 'error' ? (
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    ) : (
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    )}
                                    <span className="font-bold text-sm">{toast.message}</span>
                                </div>
                                <button onClick={() => removeToast(toast.id)} className="ml-4 hover:text-gray-300">&times;</button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => useContext(ToastContext);

        // --- COMPONENTE ADMIN DASHBOARD ---
        const App = () => {
            const { addToast } = useToast();
            const [theme, setTheme] = useState('dark');
            const [view, setView] = useState('login'); // login, dashboard, kanban, menu, history, settings
            const [password, setPassword] = useState('');
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            
            const [orders, setOrders] = useState([]);
            const [promotions, setPromotions] = useState([]);
            const [customers, setCustomers] = useState([]);

            const [storeSettings, setStoreSettings] = useState({
                isOpen: true,
                status: 'open', // open, closed, pickup_only
                phone: '5511999999999',
                address: 'Rua da Garagem, 123 - Centro'
            });
            
            // Modais
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            
            // Filtros Menu
            const [activeCategory, setActiveCategory] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                fetchData();
                setupRealtime();
            }, []);

            const setupRealtime = () => {
                // Escuta mudanças na tabela de produtos
                const productsChannel = supabase.channel('public:products')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                        if (payload.eventType === 'INSERT') {
                            setProducts(prev => [...prev, payload.new]);
                        } else if (payload.eventType === 'UPDATE') {
                            setProducts(prev => prev.map(p => p.id === payload.new.id ? payload.new : p));
                        } else if (payload.eventType === 'DELETE') {
                            setProducts(prev => prev.filter(p => p.id !== payload.old.id));
                        }
                    })
                    .subscribe();

                // Escuta mudanças na tabela de pedidos
                const ordersChannel = supabase.channel('public:orders')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                        if (payload.eventType === 'INSERT') {
                            setOrders(prev => [payload.new, ...prev]);
                            addToast(`Novo Pedido #${payload.new.id} de ${payload.new.customer}!`, "success");
                            new Audio('https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/notification.mp3').play().catch(e => console.warn("Autoplay de áudio bloqueado pelo navegador."));
                        }
                        if (payload.eventType === 'UPDATE') setOrders(prev => prev.map(o => o.id === payload.new.id ? payload.new : o));
                        if (payload.eventType === 'DELETE') setOrders(prev => prev.filter(o => o.id !== payload.old.id));
                    })
                    .subscribe();

                // Escuta Promoções
                supabase.channel('public:promotions')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'promotions' }, (payload) => {
                        if (payload.eventType === 'INSERT') setPromotions(prev => [...prev, payload.new]);
                        if (payload.eventType === 'UPDATE') setPromotions(prev => prev.map(p => p.id === payload.new.id ? payload.new : p));
                        if (payload.eventType === 'DELETE') setPromotions(prev => prev.filter(p => p.id !== payload.old.id));
                    })
                    .subscribe();

                // Escuta Clientes (Tabela usuarios)
                supabase.channel('public:usuarios')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'usuarios' }, (payload) => {
                        if (payload.eventType === 'INSERT') setCustomers(prev => [...prev, payload.new]);
                        if (payload.eventType === 'UPDATE') setCustomers(prev => prev.map(c => c.id === payload.new.id ? payload.new : c));
                        if (payload.eventType === 'DELETE') setCustomers(prev => prev.filter(c => c.id !== payload.old.id));
                    })
                    .subscribe();
            };

            const fetchData = async () => {
                if (supabase) {
                    try {
                        // Fetchs independentes para evitar falha em cascata
                        // const { data: cats } = await supabase.from('categories').select('*').order('display_order').catch(e => ({data: []}));
                        
                        // Usando categorias fixas para garantir que os produtos apareçam (igual ao site)
                        const defaultCats = [
                            { id: 1, name: 'BURGERS' },
                            { id: 2, name: 'HAMBURGUERES' },
                            { id: 3, name: 'CHICKEN' },
                            { id: 4, name: 'PORÇÕES' },
                            { id: 5, name: 'CACHORRO QUENTE' },
                            { id: 6, name: 'PASTEIS' },
                            { id: 7, name: 'SOBREMESAS' },
                            { id: 8, name: 'BEBIDAS' },
                            { id: 9, name: 'Adicionais' },
                            { id: 10, name: 'Combo Artesanal' },
                            { id: 11, name: 'Fritas' }
                        ];
                        setCategories(defaultCats);
                        setActiveCategory(defaultCats[0].id);

                        const { data: prods } = await supabase.from('products').select('*').order('name').catch(e => ({data: []}));
                        const { data: ords } = await supabase.from('orders').select('*').order('created_at', { ascending: false }).catch(e => ({data: []}));
                        const { data: promos } = await supabase.from('promotions').select('*').order('created_at', { ascending: false }).catch(e => ({data: []}));
                        const { data: custs } = await supabase.from('usuarios').select('*').order('name').catch(e => ({data: []}));
                        const { data: settings } = await supabase.from('settings').select('*').single().catch(e => ({data: null}));

                        if (prods) setProducts(prods);
                        if (ords) setOrders(ords);
                        if (promos) setPromotions(promos);
                        if (custs) setCustomers(custs);
                        if (settings) setStoreSettings(settings);
                    } catch (e) {
                        console.error("Erro ao buscar dados", e);
                    }
                }
            };

            // Toggle Theme
            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                document.body.classList.remove('light', 'dark');
                if (newTheme === 'light') document.body.classList.add('light');
                addToast(`Tema ${newTheme === 'dark' ? 'Escuro' : 'Claro'} ativado`, "success");
            };

            // --- ACTIONS ---
            const handleLogin = () => {
                if (password === 'admin') {
                    setView('dashboard');
                    addToast("Bem-vindo ao Painel!", "success");
                } else {
                    addToast("Senha incorreta!", "error");
                }
            };

            const handleForgotPassword = () => {
                addToast("Entre em contato com o suporte técnico para redefinir sua senha.", "error");
            };

            const handleUpdateProduct = async (id, field, value) => {
                // Otimistic Update (atualiza a tela antes do banco responder)
                setProducts(prev => prev.map(p => p.id === id ? { ...p, [field]: value } : p));
                if (supabase) {
                    await supabase.from('products').update({ [field]: value }).eq('id', id);
                }
            };

            const handleDeleteProduct = async () => {
                if (!deleteConfirmId) return;
                // Otimistic Update
                setProducts(prev => prev.filter(p => p.id !== deleteConfirmId));
                if (supabase) {
                    await supabase.from('products').delete().eq('id', deleteConfirmId);
                }
                setDeleteConfirmId(null);
                addToast("Produto excluído com sucesso.", "success");
            };

            const handleDuplicateProduct = async (product) => {
                const newProduct = {
                    ...product,
                    id: undefined, // Remove ID para o banco gerar um novo
                    name: `${product.name} (Cópia)`, 
                    available: false 
                };
                
                if (supabase) {
                    const { error } = await supabase.from('products').insert(newProduct);
                    if (error) addToast("Erro ao duplicar: " + error.message, "error");
                    else addToast("Produto duplicado! Edite os detalhes.", "success");
                }
            };

            // Estado do formulário de adição
            const [addProductForm, setAddProductForm] = useState({ name: '', price: '', description: '', category_id: '' });

            const openAddModal = () => {
                setAddProductForm({ 
                    name: '', 
                    price: '', 
                    description: '', 
                    category_id: activeCategory || (categories[0]?.id) 
                });
                setIsAddModalOpen(true);
            };

            const handleAddProduct = async (newProduct) => {
                if (supabase) {
                    const { error } = await supabase.from('products').insert({...newProduct, category_id: parseInt(newProduct.category_id), price: parseFloat(newProduct.price)});
                    if (error) {
                        addToast("Erro ao adicionar: " + error.message, "error");
                    } else {
                        setIsAddModalOpen(false);
                        addToast("Produto adicionado!", "success");
                    }
                }
            };

            const handleImageUpload = async (productId, file) => {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${productId}-${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    // Upload
                    const { error: uploadError } = await supabase.storage
                        .from('menu-images')
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    // Get URL
                    const { data } = supabase.storage.from('menu-images').getPublicUrl(filePath);
                    const publicUrl = data.publicUrl;

                    // Update Product
                    await handleUpdateProduct(productId, 'image_url', publicUrl);
                    addToast("Imagem atualizada com sucesso!", "success");
                } catch (error) {
                    console.error('Erro no upload:', error);
                    addToast("Erro ao fazer upload da imagem.", "error");
                }
            };

            const handleExportCSV = () => {
                const headers = ["ID", "Nome", "Categoria", "Preço", "Descrição", "Disponível", "Destaque"];
                const rows = products.map(p => [
                    p.id,
                    `"${p.name.replace(/"/g, '""')}"`,
                    categories.find(c => c.id === p.category_id)?.name || p.category_id,
                    p.price.toFixed(2),
                    `"${(p.description || '').replace(/"/g, '""')}"`,
                    p.available ? "Sim" : "Não",
                    p.featured ? "Sim" : "Não"
                ]);

                const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "produtos_garagem.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                addToast("Relatório CSV exportado!", "success");
            };

            const handlePrintOrder = (order) => {
                const line = "--------------------------------";
                let content = "";
                content += "      NA GARAGEM HAMBURGUERIA      \n";
                content += line + "\n";
                content += `Pedido: #${order.id}\n`;
                content += `Data: ${new Date(order.created_at).toLocaleString('pt-BR')}\n`;
                content += `Cliente: ${order.customer}\n`;
                content += `Tel: ${order.phone}\n`;
                content += line + "\n";
                
                order.items.forEach(item => {
                    content += `${item.name} ${item.meat ? '('+item.meat+')' : ''}\n`;
                    if(item.extras && item.extras.length) content += `  + ${item.extras.join(', ')}\n`;
                    content += `  R$ ${item.price.toFixed(2)}\n`;
                });
                
                content += line + "\n";
                content += `Taxa Entrega: R$ ${order.deliveryFee.toFixed(2)}\n`;
                content += `TOTAL: R$ ${order.total.toFixed(2)}\n`;
                content += line + "\n";
                content += `Pagamento: ${order.payment}\n`;
                content += order.address ? `Entrega: ${order.address}\n` : `RETIRADA NO BALCÃO\n`;
                content += line + "\n\n\n";

                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(`<html><head><style>body{font-family:'Courier New', monospace; white-space:pre; font-size:12px; width:80mm; margin:0; padding:10px;}</style></head><body>${content}</body></html>`);
                doc.close();
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                setTimeout(() => document.body.removeChild(iframe), 1000);
            };

            const handlePrintKitchen = (order) => {
                const line = "--------------------------------";
                let content = "";
                content += "         CUPOM COZINHA         \n";
                content += line + "\n";
                content += `Pedido: #${order.id}\n`;
                content += `Cliente: ${order.customer}\n`;
                // Tenta extrair bairro ou usa endereço completo
                content += `Local: ${order.address || 'Balcão'}\n`;
                content += line + "\n";
                
                order.items.forEach(item => {
                    content += `[ ] ${item.quantity}x ${item.name}\n`;
                    if (item.doneness) content += `    * Ponto: ${item.doneness}\n`;
                    if (item.observation) content += `    * Obs: ${item.observation}\n`;
                });
                
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(`<html><head><style>body{font-family:'Courier New', monospace; white-space:pre; font-size:14px; font-weight:bold; width:80mm; margin:0; padding:5px;}</style></head><body>${content}</body></html>`);
                doc.close();
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                setTimeout(() => document.body.removeChild(iframe), 1000);
            };

            // --- COMPONENTS ---
            
            const Sidebar = () => (
                <nav className="fixed bottom-0 left-0 w-full bg-card border-t border-border-main md:w-64 md:h-screen md:border-t-0 md:border-r md:top-0 flex md:flex-col z-50 transition-colors duration-300">
                    <div className="hidden md:flex p-6 items-center gap-2 border-b border-border-main mb-4">
                        <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/logo%20na%20garagem%20sem%20fundo%20(2).png" className="w-10 h-10 object-contain" alt="Logo" />
                        <h1 className="font-display text-xl font-bold text-text-main uppercase tracking-wider">Na Garagem</h1>
                    </div>
                    
                    <div className="flex-1 flex md:flex-col justify-around md:justify-start md:px-4 md:gap-2">
                        <button onClick={() => setView('dashboard')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'dashboard' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Dashboard />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Dashboard</span>
                        </button>
                        <button onClick={() => setView('kanban')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'kanban' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Kanban />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Kanban</span>
                        </button>
                        <button onClick={() => setView('menu')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'menu' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Menu />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Cardápio</span>
                        </button>
                        <button onClick={() => setView('promotions')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'promotions' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Percent />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Promoções</span>
                        </button>
                        <button onClick={() => setView('customers')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'customers' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Users />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Clientes</span>
                        </button>
                        <button onClick={() => setView('financial')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'financial' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Dollar />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Financeiro</span>
                        </button>
                        <button onClick={() => setView('history')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'history' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.History />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Histórico</span>
                        </button>
                        <button onClick={() => setView('settings')} className={`p-4 md:py-3 md:px-4 rounded-xl flex flex-col md:flex-row items-center gap-2 transition-all ${view === 'settings' ? 'text-[#B11226] bg-[#B11226]/10' : 'text-text-muted hover:text-text-main'}`}>
                            <Icons.Settings />
                            <span className="text-[10px] md:text-sm font-bold uppercase">Loja</span>
                        </button>
                    </div>

                    <div className="hidden md:block p-4 border-t border-border-main space-y-2">
                        <button onClick={toggleTheme} className="w-full flex items-center gap-2 text-text-muted hover:text-text-main transition-colors p-2">
                            {theme === 'dark' ? <Icons.Sun /> : <Icons.Moon />}
                            <span className="text-sm font-bold uppercase">{theme === 'dark' ? 'Modo Claro' : 'Modo Escuro'}</span>
                        </button>
                        <button onClick={() => setView('login')} className="w-full flex items-center gap-2 text-text-muted hover:text-text-main transition-colors p-2">
                            <Icons.Logout />
                            <span className="text-sm font-bold uppercase">Sair</span>
                        </button>
                    </div>
                </nav>
            );

            const DashboardView = () => {
                // Dados para o Gráfico de Pizza
                const totalProducts = products.length;
                const pieData = categories.map((cat, index) => {
                    const count = products.filter(p => p.category_id === cat.id).length;
                    const percentage = totalProducts > 0 ? (count / totalProducts) * 100 : 0;
                    const colors = ['#B11226', '#F5F5F5', '#525252', '#262626'];
                    return {
                        name: cat.name,
                        count,
                        percentage,
                        color: colors[index % colors.length]
                    };
                }).filter(d => d.count > 0);

                let cumulativePercent = 0;

                // Cálculos Financeiros
                const todayOrders = orders.filter(o => o.status === 'Finalizado'); // Apenas finalizados contam
                const dailyRevenue = todayOrders.reduce((acc, o) => acc + o.total, 0);
                const averageTicket = todayOrders.length ? (dailyRevenue / todayOrders.length) : 0;

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="bg-card p-6 rounded-2xl border border-border-main shadow-lg transition-colors duration-300">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h2 className="text-text-muted text-xs font-bold uppercase mb-1">Status da Loja</h2>
                                    <p className={`text-3xl font-display font-bold ${storeSettings.status === 'open' ? 'text-green-500' : storeSettings.status === 'pickup_only' ? 'text-yellow-500' : 'text-red-500'}`}>
                                        {storeSettings.status === 'open' ? 'ABERTA' : storeSettings.status === 'pickup_only' ? 'APENAS RETIRADA' : 'FECHADA'}
                                    </p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setStoreSettings(prev => ({...prev, status: 'open'})); supabase.from('settings').update({ status: 'open' }).eq('id', storeSettings.id).then(() => addToast("Loja Aberta!", "success")); }} className={`px-4 py-2 rounded font-bold uppercase text-xs transition-colors ${storeSettings.status === 'open' ? 'bg-green-600 text-white' : 'bg-element text-text-muted hover:bg-gray-700'}`}>
                                        Abrir Loja
                                    </button>
                                    <button onClick={() => { setStoreSettings(prev => ({...prev, status: 'pickup_only'})); supabase.from('settings').update({ status: 'pickup_only' }).eq('id', storeSettings.id).then(() => addToast("Modo Retirada!", "success")); }} className={`px-4 py-2 rounded font-bold uppercase text-xs transition-colors ${storeSettings.status === 'pickup_only' ? 'bg-yellow-600 text-white' : 'bg-element text-text-muted hover:bg-gray-700'}`}>
                                        Só Retirada
                                    </button>
                                    <button onClick={() => { setStoreSettings(prev => ({...prev, status: 'closed'})); supabase.from('settings').update({ status: 'closed' }).eq('id', storeSettings.id).then(() => addToast("Loja Fechada!", "success")); }} className={`px-4 py-2 rounded font-bold uppercase text-xs transition-colors ${storeSettings.status === 'closed' ? 'bg-red-600 text-white' : 'bg-element text-text-muted hover:bg-gray-700'}`}>
                                        Fechar
                                    </button>
                                </div>
                            </div>
                            <p className="text-xs text-text-muted">
                                {storeSettings.status === 'open' && "Recebendo pedidos para Entrega e Retirada."}
                                {storeSettings.status === 'pickup_only' && "Clientes só poderão escolher a opção 'Retirada'."}
                                {storeSettings.status === 'closed' && "Nenhum pedido será aceito no site."}
                            </p>
                        </div>

                        {/* Cards Financeiros */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-card p-5 rounded-xl border border-border-main">
                                <h3 className="text-text-muted text-xs font-bold uppercase mb-2">Faturamento do Dia</h3>
                                <p className="text-2xl font-bold text-green-500">R$ {dailyRevenue.toFixed(2)}</p>
                            </div>
                            <div className="bg-card p-5 rounded-xl border border-border-main">
                                <h3 className="text-text-muted text-xs font-bold uppercase mb-2">Ticket Médio</h3>
                                <p className="text-2xl font-bold text-text-main">R$ {averageTicket.toFixed(2)}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Gráfico Simples SVG (Barras) */}
                            <div className="bg-card p-6 rounded-2xl border border-border-main transition-colors duration-300">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-text-muted text-xs font-bold uppercase">Vendas da Semana</h2>
                                    <button onClick={() => window.print()} className="text-text-muted hover:text-text-main transition-colors" title="Imprimir Relatório">
                                        <Icons.Printer />
                                    </button>
                                </div>
                                <div className="h-40 w-full flex items-end gap-2">
                                    {[40, 70, 45, 90, 60, 80, 95].map((h, i) => (
                                        <div key={i} className="flex-1 bg-[#B11226]/20 rounded-t hover:bg-[#B11226] transition-colors relative group">
                                            <div className="absolute bottom-0 w-full bg-[#B11226]" style={{ height: `${h}%` }}></div>
                                            <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-text-main text-bg-main text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">{h}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex justify-between mt-2 text-xs text-text-muted font-mono">
                                    <span>SEG</span><span>TER</span><span>QUA</span><span>QUI</span><span>SEX</span><span>SAB</span><span>DOM</span>
                                </div>
                            </div>

                            {/* Gráfico de Pizza (Donut) */}
                            <div className="bg-card p-6 rounded-2xl border border-border-main flex flex-col transition-colors duration-300">
                                <h2 className="text-text-muted text-xs font-bold uppercase mb-6">Distribuição por Categoria</h2>
                                <div className="flex items-center justify-center gap-8 flex-1">
                                    <div className="relative w-32 h-32 flex-shrink-0">
                                        <svg viewBox="0 0 32 32" className="transform -rotate-90 w-full h-full">
                                            {pieData.map((slice, i) => {
                                                const dashArray = `${slice.percentage} ${100 - slice.percentage}`;
                                                const dashOffset = -cumulativePercent;
                                                cumulativePercent += slice.percentage;
                                                return (
                                                    <circle key={i} cx="16" cy="16" r="15.9155" fill="none" stroke={slice.color} strokeWidth="6" strokeDasharray={dashArray} strokeDashoffset={dashOffset} />
                                                );
                                            })}
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <span className="text-2xl font-bold text-text-main leading-none">{totalProducts}</span>
                                            <span className="text-[8px] uppercase text-text-muted font-bold">Itens</span>
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {pieData.map((slice, i) => (
                                            <div key={i} className="flex items-center justify-between text-xs">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: slice.color }}></div>
                                                    <span className="text-text-muted">{slice.name}</span>
                                                </div>
                                                <span className="font-bold text-text-main">{Math.round(slice.percentage)}%</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {categories.map(cat => (
                                <div key={cat.id} className="bg-element p-5 rounded-xl border border-border-main transition-colors duration-300">
                                    <h3 className="text-text-muted text-xs font-bold uppercase mb-2">{cat.name}</h3>
                                    <p className="text-2xl font-bold text-text-main">{products.filter(p => p.category_id === cat.id && p.available).length} <span className="text-sm text-text-muted font-normal">/ {products.filter(p => p.category_id === cat.id).length}</span></p>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const MenuView = () => (
                <div className="animate-fade-in h-full flex flex-col">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide w-full md:w-auto">
                            {categories.map(cat => (
                                <button 
                                    key={cat.id} 
                                    onClick={() => setActiveCategory(cat.id)}
                                    className={`px-4 py-2 rounded-full text-xs font-bold uppercase whitespace-nowrap transition-colors ${activeCategory === cat.id ? 'bg-[#B11226] text-white' : 'bg-element text-text-muted hover:text-text-main'}`}
                                >
                                    {cat.name}
                                </button>
                            ))}
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <div className="relative flex-1 md:w-64">
                                <input 
                                    type="text" 
                                    placeholder="Buscar produto..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full bg-element border border-border-main rounded-lg p-2 pl-9 text-text-main text-sm focus:border-[#B11226] outline-none transition-colors duration-300"
                                />
                                <svg className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </div>
                            <button onClick={handleExportCSV} className="bg-element text-text-muted border border-border-main p-2 rounded-lg hover:text-text-main hover:border-gray-600 shadow-lg flex-shrink-0 transition-colors duration-300" title="Exportar CSV">
                                <Icons.Download />
                            </button>
                            <button onClick={openAddModal} className="bg-white text-black p-2 rounded-lg hover:bg-gray-200 shadow-lg flex-shrink-0">
                                <Icons.Plus />
                            </button>
                        </div>
                    </div>

                    <div className="grid gap-4 pb-24 md:pb-0">
                        {products.filter(p => p.category_id === activeCategory && p.name.toLowerCase().includes(searchTerm.toLowerCase())).map(product => (
                            <div key={product.id} className={`bg-card p-4 rounded-xl border flex flex-col md:flex-row gap-4 transition-all duration-300 ${product.available ? 'border-border-main' : 'border-red-900/30 opacity-75'}`}>
                                {/* Imagem */}
                                <div className="relative w-full md:w-24 h-32 md:h-24 bg-black rounded-lg overflow-hidden group border border-border-main flex-shrink-0">
                                    {product.image_url ? <img src={product.image_url} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-text-muted"><Icons.Image /></div>}
                                    <label className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                                        <Icons.Upload />
                                        <span className="text-[8px] font-bold uppercase mt-1 text-white">Alterar</span>
                                        <input type="file" className="hidden" accept="image/*" onChange={(e) => e.target.files[0] && handleImageUpload(product.id, e.target.files[0])} />
                                    </label>
                                </div>

                                {/* Inputs */}
                                <div className="flex-1 space-y-2">
                                    <input 
                                        value={product.name} 
                                        onChange={(e) => handleUpdateProduct(product.id, 'name', e.target.value)}
                                        className="bg-transparent font-display font-bold text-lg w-full focus:outline-none focus:border-b border-[#B11226] placeholder-text-muted text-text-main"
                                        placeholder="Nome do Produto"
                                    />
                                    <textarea 
                                        value={product.description} 
                                        onChange={(e) => handleUpdateProduct(product.id, 'description', e.target.value)}
                                        className="bg-transparent text-sm text-text-muted w-full focus:outline-none focus:text-text-main resize-none h-10"
                                        placeholder="Descrição..."
                                    />
                                </div>

                                {/* Controles */}
                                <div className="flex flex-row md:flex-col justify-between items-end gap-3 border-t md:border-t-0 border-border-main pt-3 md:pt-0">
                                    <div className="flex items-center bg-main rounded border border-border-main px-2 py-1">
                                        <span className="text-text-muted text-xs font-bold mr-1">R$</span>
                                        <input 
                                            type="number" 
                                            value={product.price} 
                                            onChange={(e) => handleUpdateProduct(product.id, 'price', parseFloat(e.target.value))}
                                            className="bg-transparent w-16 text-text-main font-bold text-sm focus:outline-none text-right"
                                        />
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => handleDuplicateProduct(product)}
                                            className="p-2 rounded text-text-muted hover:text-text-main hover:bg-element"
                                            title="Duplicar"
                                        >
                                            <Icons.Copy />
                                        </button>
                                        <button 
                                            onClick={() => handleUpdateProduct(product.id, 'featured', !product.featured)}
                                            className={`p-2 rounded ${product.featured ? 'text-yellow-400 bg-yellow-400/10' : 'text-text-muted hover:text-text-muted'}`}
                                            title="Destaque"
                                        >
                                            <Icons.Star filled={true} />
                                        </button>
                                        <button 
                                            onClick={() => handleUpdateProduct(product.id, 'available', !product.available)}
                                            className={`px-3 py-1 rounded text-[10px] font-bold uppercase border ${product.available ? 'border-green-900 text-green-500 bg-green-900/20' : 'border-red-900 text-red-500 bg-red-900/20'}`}
                                        >
                                            {product.available ? 'Em Estoque' : 'Esgotado'}
                                        </button>
                                        <button onClick={() => setDeleteConfirmId(product.id)} className="text-red-900 hover:text-red-500 p-2">
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {products.filter(p => p.category_id === activeCategory && p.name.toLowerCase().includes(searchTerm.toLowerCase())).length === 0 && (
                            <div className="text-center text-text-muted py-8 text-sm">Nenhum produto encontrado.</div>
                        )}
                    </div>
                </div>
            );

            const KanbanView = () => {
                const columns = [
                    { id: 'Na Cozinha', title: 'Na Cozinha', color: 'border-yellow-500' },
                    { id: 'Saiu para Entrega', title: 'Saiu para Entrega', color: 'border-blue-500' },
                    { id: 'Finalizado', title: 'Finalizado', color: 'border-green-500' }
                ];

                const moveOrder = async (order, newStatus) => {
                    const originalStatus = order.status;
                    // Atualização otimista na UI
                    setOrders(prev => prev.map(o => o.id === order.id ? { ...o, status: newStatus } : o));

                    // Persistência no Supabase
                    const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', order.id);

                    if (error) {
                        addToast("Erro ao atualizar status.", "error");
                        // Reverte em caso de erro
                        setOrders(prev => prev.map(o => o.id === order.id ? { ...o, status: originalStatus } : o));
                        return;
                    }

                    addToast(`Pedido #${order.id} movido para ${newStatus}.`, "success");

                    // Lógica de negócio ao finalizar
                    if (newStatus === 'Finalizado') {
                        // Se o pagamento for 'Fiado', atualiza o saldo devedor do cliente
                        if (order.payment === 'Fiado' && order.user_id) {
                            const customer = customers.find(c => c.id === order.user_id);
                            if (customer) {
                                const currentDebt = customer.saldo_devedor || 0;
                                const newDebt = currentDebt + order.total;
                                const { error: debtError } = await supabase.from('usuarios').update({ saldo_devedor: newDebt }).eq('id', order.user_id);

                                if (debtError) {
                                    addToast(`Erro ao registrar fiado para ${customer.name}.`, "error");
                                } else {
                                    addToast(`Fiado de R$ ${order.total.toFixed(2)} registrado para ${customer.name}.`, "success");
                                }
                            }
                        }
                    }
                };

                return (
                    <div className="animate-fade-in h-full overflow-x-auto">
                        <div className="flex gap-4 min-w-max h-full pb-4">
                            {columns.map(col => (
                                <div key={col.id} className={`w-80 bg-card rounded-xl border-t-4 ${col.color} p-4 flex flex-col h-full`}>
                                    <h3 className="font-bold text-text-main uppercase mb-4 flex justify-between">
                                        {col.title}
                                        <span className="bg-element px-2 rounded text-xs py-0.5">{orders.filter(o => o.status === col.id).length}</span>
                                    </h3>
                                    <div className="space-y-3 overflow-y-auto flex-1 custom-scrollbar pr-2">
                                        {orders.filter(o => o.status === col.id).map(order => (
                                            <div key={order.id} className="bg-element p-3 rounded border border-border-main shadow-sm hover:shadow-md transition-shadow">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="font-bold text-text-main">#{order.id}</span>
                                                    <span className="text-xs text-text-muted">{new Date(order.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                                                </div>
                                                <p className="text-sm text-text-main font-bold mb-1">{order.customer}</p>
                                                <p className="text-xs text-text-muted mb-3 line-clamp-2">{order.items.map(i => i.name).join(', ')}</p>
                                                <div className="flex justify-between items-center mt-2 pt-2 border-t border-border-main">
                                                    <span className="text-[#B11226] font-bold text-sm">R$ {order.total.toFixed(2)}</span>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handlePrintOrder(order)} className="p-1.5 hover:bg-gray-700 rounded text-text-muted hover:text-white" title="Imprimir"><Icons.Printer /></button>
                                                        <button onClick={() => handlePrintKitchen(order)} className="p-1.5 hover:bg-gray-700 rounded text-text-muted hover:text-white" title="Cupom Cozinha"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></button>
                                                        {col.id !== 'Finalizado' && (
                                                            <button onClick={() => moveOrder(order, col.id === 'Na Cozinha' ? 'Saiu para Entrega' : 'Finalizado')} className="p-1.5 hover:bg-green-900/50 rounded text-green-500" title="Avançar">➜</button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const PromotionsView = () => {
                const [newPromo, setNewPromo] = useState({ title: '', description: '', discount_percentage: 0 });

                const handleAddPromo = async () => {
                    if (!newPromo.title) return addToast("Título obrigatório", "error");
                    const { error } = await supabase.from('promotions').insert(newPromo);
                    if (error) addToast("Erro ao criar promoção", "error");
                    else {
                        addToast("Promoção criada!", "success");
                        setNewPromo({ title: '', description: '', discount_percentage: 0 });
                    }
                };

                const togglePromo = async (id, currentStatus) => {
                    await supabase.from('promotions').update({ active: !currentStatus }).eq('id', id);
                };

                const deletePromo = async (id) => {
                    if(confirm("Excluir promoção?")) await supabase.from('promotions').delete().eq('id', id);
                };

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="bg-card p-6 rounded-2xl border border-border-main">
                            <h3 className="font-bold text-text-main uppercase mb-4">Nova Promoção</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input placeholder="Título (ex: Terça Maluca)" value={newPromo.title} onChange={e => setNewPromo({...newPromo, title: e.target.value})} className="bg-element p-3 rounded border border-border-main text-text-main outline-none focus:border-[#B11226]" />
                                <input placeholder="Descrição" value={newPromo.description} onChange={e => setNewPromo({...newPromo, description: e.target.value})} className="bg-element p-3 rounded border border-border-main text-text-main outline-none focus:border-[#B11226]" />
                                <div className="flex gap-2">
                                    <input type="number" placeholder="% Desconto" value={newPromo.discount_percentage} onChange={e => setNewPromo({...newPromo, discount_percentage: parseFloat(e.target.value)})} className="bg-element p-3 rounded border border-border-main text-text-main outline-none focus:border-[#B11226] w-24" />
                                    <button onClick={handleAddPromo} className="flex-1 bg-[#B11226] text-white font-bold uppercase rounded hover:bg-red-700">Criar</button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {promotions.map(promo => (
                                <div key={promo.id} className={`bg-card p-4 rounded-xl border ${promo.active ? 'border-[#B11226]' : 'border-border-main opacity-75'} relative`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="font-bold text-lg text-text-main">{promo.title}</h4>
                                        <span className="bg-element px-2 py-1 rounded text-xs font-bold">{promo.discount_percentage}% OFF</span>
                                    </div>
                                    <p className="text-sm text-text-muted mb-4">{promo.description}</p>
                                    <div className="flex justify-between items-center">
                                        <button onClick={() => togglePromo(promo.id, promo.active)} className={`text-xs font-bold uppercase px-3 py-1 rounded ${promo.active ? 'bg-green-900 text-green-400' : 'bg-gray-700 text-gray-400'}`}>
                                            {promo.active ? 'Ativa' : 'Inativa'}
                                        </button>
                                        <button onClick={() => deletePromo(promo.id)} className="text-red-500 hover:text-red-400"><Icons.Trash /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const CustomersView = () => {
                const [search, setSearch] = useState('');
                const [debtAmount, setDebtAmount] = useState('');
                const [selectedCustomer, setSelectedCustomer] = useState(null);

                const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(search.toLowerCase()) || (c.phone && c.phone.includes(search)));

                const updatePoints = async (id, newPoints) => {
                    await supabase.from('usuarios').update({ points: newPoints }).eq('id', id);
                };

                const handleAddDebt = async () => {
                    if (!selectedCustomer || !debtAmount) return;
                    const newDebt = (selectedCustomer.saldo_devedor || 0) + parseFloat(debtAmount);
                    await supabase.from('usuarios').update({ saldo_devedor: newDebt }).eq('id', selectedCustomer.id);
                    addToast(`Fiado registrado! Novo saldo: R$ ${newDebt.toFixed(2)}`, "success");
                    setDebtAmount('');
                    setSelectedCustomer(null);
                };

                const isDelinquent = (customer) => {
                    const daysSinceLastOrder = customer.last_order_at 
                        ? (new Date() - new Date(customer.last_order_at)) / (1000 * 60 * 60 * 24) 
                        : 0;
                    return (customer.saldo_devedor > 100) || (daysSinceLastOrder > 30 && customer.saldo_devedor > 0);
                };

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="flex justify-between items-center">
                            <div className="relative w-full max-w-md">
                                <input type="text" placeholder="Buscar cliente por nome ou telefone..." value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-element border border-border-main rounded-lg p-3 pl-10 text-text-main outline-none focus:border-[#B11226]" />
                                <svg className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </div>
                            <div className="bg-card px-4 py-2 rounded border border-border-main">
                                <span className="text-xs text-text-muted uppercase font-bold">Total Clientes</span>
                                <p className="text-xl font-bold text-text-main">{customers.length}</p>
                            </div>
                        </div>

                        <div className="bg-card rounded-xl border border-border-main overflow-hidden">
                            <table className="w-full text-left">
                                <thead className="bg-element text-xs uppercase text-text-muted font-bold">
                                    <tr>
                                        <th className="p-4">Cliente</th>
                                        <th className="p-4">Telefone</th>
                                        <th className="p-4">Último Pedido</th>
                                        <th className="p-4">Fidelidade (Pontos)</th>
                                        <th className="p-4">Fiado (Dívida)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-border-main">
                                    {filteredCustomers.map(c => (
                                        <tr key={c.id} className="hover:bg-element/50 transition-colors">
                                            <td className="p-4 font-bold text-text-main flex items-center gap-2">
                                                {c.name}
                                                {isDelinquent(c) && (
                                                    <span className="text-red-500" title="Inadimplente: Saldo > R$100 ou > 30 dias sem compra"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></span>
                                                )}
                                            </td>
                                            <td className="p-4 text-text-muted">{c.phone}</td>
                                            <td className="p-4 text-text-muted text-sm">{c.last_order_at ? new Date(c.last_order_at).toLocaleDateString('pt-BR') : '-'}</td>
                                            <td className="p-4">
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => updatePoints(c.id, Math.max(0, c.points - 10))} className="w-6 h-6 rounded bg-element hover:bg-border-main flex items-center justify-center">-</button>
                                                    <input type="number" value={c.points} onChange={(e) => updatePoints(c.id, parseInt(e.target.value) || 0)} className="w-16 bg-transparent text-center font-bold text-[#B11226] outline-none" />
                                                    <button onClick={() => updatePoints(c.id, c.points + 10)} className="w-6 h-6 rounded bg-element hover:bg-border-main flex items-center justify-center">+</button>
                                                </div>
                                            </td>
                                            <td className="p-4">
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-bold ${c.saldo_devedor > 0 ? 'text-red-500' : 'text-green-500'}`}>R$ {(c.saldo_devedor || 0).toFixed(2)}</span>
                                                    <button onClick={() => setSelectedCustomer(c)} className="text-xs bg-element border border-border-main px-2 py-1 rounded hover:bg-white hover:text-black transition-colors">Adicionar</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Modal Fiado */}
                        {selectedCustomer && (
                            <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                                <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setSelectedCustomer(null)}></div>
                                <div className="relative w-full max-w-sm bg-card rounded-xl p-6 border border-border-main shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto">
                                    <h3 className="font-bold text-text-main mb-4">Registrar Fiado para {selectedCustomer.name}</h3>
                                    <input type="number" placeholder="Valor (R$)" value={debtAmount} onChange={e => setDebtAmount(e.target.value)} className="w-full bg-element border border-border-main rounded p-3 text-text-main mb-4 focus:border-[#B11226] outline-none" />
                                    <div className="flex gap-2">
                                        <button onClick={() => setSelectedCustomer(null)} className="flex-1 bg-element text-text-main font-bold text-xs uppercase py-3 rounded hover:bg-gray-600">Cancelar</button>
                                        <button onClick={handleAddDebt} className="flex-1 bg-[#B11226] text-white font-bold text-xs uppercase py-3 rounded hover:bg-red-700">Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const FinancialView = () => {
                // Cálculos simples baseados nos pedidos carregados (orders)
                // Para um sistema real robusto, faria queries agregadas no banco
                const totalRevenue = orders.filter(o => o.status === 'Finalizado').reduce((acc, o) => acc + o.total, 0);
                const totalOrders = orders.length;
                const canceledOrders = orders.filter(o => o.status === 'Cancelado').length;
                const averageTicket = totalOrders > 0 ? totalRevenue / (totalOrders - canceledOrders) : 0;

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-card p-6 rounded-xl border border-border-main">
                                <h3 className="text-xs font-bold text-text-muted uppercase mb-2">Receita Total</h3>
                                <p className="text-3xl font-bold text-green-500">R$ {totalRevenue.toFixed(2)}</p>
                            </div>
                            <div className="bg-card p-6 rounded-xl border border-border-main">
                                <h3 className="text-xs font-bold text-text-muted uppercase mb-2">Ticket Médio</h3>
                                <p className="text-3xl font-bold text-text-main">R$ {averageTicket.toFixed(2)}</p>
                            </div>
                            <div className="bg-card p-6 rounded-xl border border-border-main">
                                <h3 className="text-xs font-bold text-text-muted uppercase mb-2">Total Pedidos</h3>
                                <p className="text-3xl font-bold text-blue-500">{totalOrders}</p>
                            </div>
                            <div className="bg-card p-6 rounded-xl border border-border-main">
                                <h3 className="text-xs font-bold text-text-muted uppercase mb-2">Cancelados</h3>
                                <p className="text-3xl font-bold text-red-500">{canceledOrders}</p>
                            </div>
                        </div>

                        <div className="bg-card p-6 rounded-xl border border-border-main">
                            <h3 className="font-bold text-text-main uppercase mb-6">Últimas Transações</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="text-xs uppercase text-text-muted border-b border-border-main">
                                        <tr>
                                            <th className="p-3">ID</th>
                                            <th className="p-3">Data</th>
                                            <th className="p-3">Cliente</th>
                                            <th className="p-3">Pagamento</th>
                                            <th className="p-3">Valor</th>
                                            <th className="p-3">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {orders.slice(0, 10).map(o => (
                                            <tr key={o.id} className="border-b border-border-main hover:bg-element/50">
                                                <td className="p-3 font-mono">#{o.id}</td>
                                                <td className="p-3">{new Date(o.created_at).toLocaleDateString('pt-BR')}</td>
                                                <td className="p-3">{o.customer}</td>
                                                <td className="p-3">{o.payment}</td>
                                                <td className="p-3 font-bold text-green-500">R$ {o.total.toFixed(2)}</td>
                                                <td className="p-3"><span className={`text-[10px] px-2 py-1 rounded uppercase font-bold ${o.status === 'Cancelado' ? 'bg-red-900/30 text-red-500' : 'bg-green-900/30 text-green-500'}`}>{o.status}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => {
                const [currentPage, setCurrentPage] = useState(1);
                const itemsPerPage = 5;

                const totalPages = Math.ceil(orders.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const currentOrders = orders.slice(startIndex, startIndex + itemsPerPage);

                const goToPage = (page) => {
                    if (page >= 1 && page <= totalPages) setCurrentPage(page);
                };

                // Dados do Gráfico de Linha
                const chartData = useMemo(() => {
                    const data = {};
                    orders.forEach(order => {
                        if (order.status === 'Cancelado') return;
                        const date = new Date(order.created_at).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                        data[date] = (data[date] || 0) + order.total;
                    });
                    return Object.entries(data)
                        .map(([date, total]) => ({ date, total }))
                        .sort((a, b) => {
                            const [da, ma] = a.date.split('/').map(Number);
                            const [db, mb] = b.date.split('/').map(Number);
                            return ma - mb || da - db;
                        });
                }, [orders]);

                const maxRevenue = Math.max(...chartData.map(d => d.total), 1);

                const getPath = () => {
                    if (chartData.length === 0) return "";
                    if (chartData.length === 1) return `M0,${100 - (chartData[0].total / maxRevenue) * 80} L100,${100 - (chartData[0].total / maxRevenue) * 80}`;
                    return "M" + chartData.map((d, i) => {
                        const x = (i / (chartData.length - 1)) * 100;
                        const y = 100 - (d.total / maxRevenue) * 80;
                        return `${x},${y}`;
                    }).join(" L");
                };

                const handleExportPDF = () => {
                    if (!window.jspdf) {
                        addToast("Erro ao carregar biblioteca PDF.", "error");
                        return;
                    }
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Cabeçalho
                    doc.setFontSize(18);
                    doc.text("Histórico de Vendas - Na Garagem", 14, 22);
                    doc.setFontSize(10);
                    doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 30);

                    // Tabela
                    const tableColumn = ["ID", "Data", "Cliente", "Itens", "Total", "Status"];
                    const tableRows = orders.map(order => [
                        order.id,
                        new Date(order.created_at).toLocaleString('pt-BR'),
                        order.customer,
                        order.items.map(i => i.name).join(', '),
                        `R$ ${order.total.toFixed(2)}`,
                        order.status
                    ]);

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 35,
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [177, 18, 38] } // #B11226
                    });

                    doc.save("historico_vendas.pdf");
                    addToast("PDF exportado com sucesso!", "success");
                };

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="bg-card p-6 rounded-2xl border border-border-main shadow-lg transition-colors duration-300">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-display text-xl font-bold uppercase text-text-main">Histórico de Vendas</h2>
                                <button onClick={handleExportPDF} className="flex items-center gap-2 bg-element hover:bg-border-main text-text-main px-4 py-2 rounded-lg transition-colors text-xs font-bold uppercase border border-border-main">
                                    <Icons.Download /> Exportar PDF
                                </button>
                            </div>

                            {/* Gráfico de Tendência */}
                            {chartData.length > 0 && (
                                <div className="mb-8 p-6 bg-element/30 rounded-xl border border-border-main">
                                    <h3 className="text-text-muted text-xs font-bold uppercase mb-6">Tendência de Vendas (Diária)</h3>
                                    <div className="h-48 w-full relative">
                                        <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                                            {/* Grid Lines */}
                                            <line x1="0" y1="0" x2="100" y2="0" stroke="var(--border-main)" strokeWidth="0.5" strokeDasharray="2" opacity="0.5" />
                                            <line x1="0" y1="50" x2="100" y2="50" stroke="var(--border-main)" strokeWidth="0.5" strokeDasharray="2" opacity="0.5" />
                                            <line x1="0" y1="100" x2="100" y2="100" stroke="var(--border-main)" strokeWidth="0.5" opacity="0.5" />
                                            
                                            {/* Area Fill */}
                                            <defs>
                                                <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                                    <stop offset="0%" stopColor="#B11226" stopOpacity="0.2" />
                                                    <stop offset="100%" stopColor="#B11226" stopOpacity="0" />
                                                </linearGradient>
                                            </defs>
                                            <path d={`${getPath()} L100,100 L0,100 Z`} fill="url(#chartGradient)" />
                                            
                                            {/* Line */}
                                            <path d={getPath()} fill="none" stroke="#B11226" strokeWidth="1.5" vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />

                                            {/* Points & Tooltips */}
                                            {chartData.map((d, i) => {
                                                const x = chartData.length > 1 ? (i / (chartData.length - 1)) * 100 : 50;
                                                const y = 100 - (d.total / maxRevenue) * 80;
                                                return (
                                                    <g key={i} className="group">
                                                        <circle cx={x} cy={y} r="2" fill="#B11226" stroke="var(--bg-card)" strokeWidth="1" vectorEffect="non-scaling-stroke" className="cursor-pointer hover:r-3 transition-all" />
                                                        <rect x={x - 12} y={y - 18} width="24" height="12" rx="2" fill="var(--bg-card)" stroke="var(--border-main)" strokeWidth="0.5" className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" vectorEffect="non-scaling-stroke" />
                                                        <text x={x} y={y - 10} textAnchor="middle" fontSize="4" fill="var(--text-main)" fontWeight="bold" className="opacity-0 group-hover:opacity-100 transition-opacity select-none pointer-events-none">R${d.total}</text>
                                                    </g>
                                                );
                                            })}
                                        </svg>
                                        <div className="flex justify-between mt-2 text-[10px] text-text-muted font-mono">{chartData.map((d, i) => <span key={i}>{d.date}</span>)}</div>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="text-text-muted text-xs uppercase border-b border-border-main">
                                            <th className="p-3">ID</th>
                                            <th className="p-3">Data</th>
                                            <th className="p-3">Cliente</th>
                                            <th className="p-3">Resumo</th>
                                            <th className="p-3">Total</th>
                                            <th className="p-3">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm text-text-main">
                                        {currentOrders.map(order => (
                                            <tr key={order.id} className="border-b border-border-main hover:bg-element transition-colors">
                                                <td className="p-3 font-mono text-xs">{order.id}</td>
                                                <td className="p-3">{new Date(order.created_at).toLocaleString('pt-BR')}</td>
                                                <td className="p-3 font-bold">{order.customer}</td>
                                                <td className="p-3 text-text-muted truncate max-w-xs">{order.items.map(i => i.name).join(', ')}</td>
                                                <td className="p-3 text-[#B11226] font-bold">R$ {order.total.toFixed(2)}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${
                                                        order.status === 'Finalizado' || order.status === 'Entregue' ? 'bg-green-900/30 text-green-500' :
                                                        order.status === 'Cancelado' ? 'bg-red-900/30 text-red-500' : 'bg-yellow-900/30 text-yellow-500'
                                                    }`}>
                                                        {order.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* Paginação */}
                            {totalPages > 1 && (
                                <div className="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t border-border-main gap-4">
                                    <span className="text-xs text-text-muted">
                                        Mostrando {startIndex + 1}-{Math.min(startIndex + itemsPerPage, orders.length)} de {orders.length} pedidos
                                    </span>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => goToPage(currentPage - 1)} 
                                            disabled={currentPage === 1}
                                            className="px-3 py-1 rounded border border-border-main text-text-muted hover:text-text-main disabled:opacity-50 disabled:cursor-not-allowed text-xs font-bold uppercase transition-colors"
                                        >
                                            Anterior
                                        </button>
                                        {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                                            <button
                                                key={page}
                                                onClick={() => goToPage(page)}
                                                className={`px-3 py-1 rounded border text-xs font-bold uppercase transition-colors ${currentPage === page ? 'bg-[#B11226] border-[#B11226] text-white' : 'border-border-main text-text-muted hover:text-text-main'}`}
                                            >
                                                {page}
                                            </button>
                                        ))}
                                        <button 
                                            onClick={() => goToPage(currentPage + 1)} 
                                            disabled={currentPage === totalPages}
                                            className="px-3 py-1 rounded border border-border-main text-text-muted hover:text-text-main disabled:opacity-50 disabled:cursor-not-allowed text-xs font-bold uppercase transition-colors"
                                        >
                                            Próxima
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const SettingsView = () => (
                <div className="animate-fade-in max-w-lg">
                    <div className="bg-card p-6 rounded-2xl border border-border-main space-y-6 transition-colors duration-300">
                        <h2 className="font-display text-xl font-bold uppercase text-text-main mb-4">Configurações da Loja</h2>
                        
                        <div>
                            <label className="block text-xs font-bold text-text-muted uppercase mb-2">WhatsApp (Apenas números)</label>
                            <input 
                                type="text" 
                                value={storeSettings.phone}
                                onChange={(e) => setStoreSettings(prev => ({...prev, phone: e.target.value}))}
                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none transition-colors duration-300"
                            />
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-text-muted uppercase mb-2">Endereço Completo</label>
                            <textarea 
                                value={storeSettings.address}
                                onChange={(e) => setStoreSettings(prev => ({...prev, address: e.target.value}))}
                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none h-24 resize-none transition-colors duration-300"
                            />
                        </div>

                        <button className="w-full bg-[#B11226] text-white font-bold uppercase py-3 rounded hover:bg-red-700 transition-colors">
                            Salvar Alterações
                        </button>
                    </div>
                </div>
            );

            const DeleteConfirmModal = () => {
                if (!deleteConfirmId) return null;
                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setDeleteConfirmId(null)}></div>
                        <div className="relative w-full max-w-xs bg-card rounded-xl p-6 border border-border-main shadow-2xl animate-fade-in text-center transition-colors duration-300">
                            <div className="w-12 h-12 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                <Icons.Trash />
                            </div>
                            <h3 className="font-bold text-text-main mb-2">Excluir Produto?</h3>
                            <p className="text-text-muted text-sm mb-6">Essa ação não pode ser desfeita.</p>
                            <div className="flex gap-2">
                                <button onClick={() => setDeleteConfirmId(null)} className="flex-1 bg-element text-text-main font-bold text-xs uppercase py-3 rounded hover:bg-gray-600 transition-colors">Cancelar</button>
                                <button onClick={handleDeleteProduct} className="flex-1 bg-red-600 text-white font-bold text-xs uppercase py-3 rounded hover:bg-red-700">Excluir</button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-main text-text-main font-sans flex flex-col md:flex-row transition-colors duration-300">
                    {view === 'login' ? (
                        <div className="w-full h-screen flex items-center justify-center bg-[radial-gradient(circle_at_center,_#1a1a1a_0%,_#000_100%)]">
                            <div className="bg-card p-8 rounded-2xl border border-border-main shadow-2xl w-full max-w-sm text-center animate-fade-in">
                                <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/logo%20na%20garagem%20sem%20fundo%20(2).png" className="w-32 h-32 object-contain mx-auto mb-6 drop-shadow-lg" alt="Logo" />
                                <h1 className="font-display text-2xl font-bold uppercase text-white mb-2">Acesso Restrito</h1>
                                <p className="text-gray-500 text-sm mb-6">Painel Administrativo Na Garagem</p>
                                <input 
                                    type="password" 
                                    placeholder="Senha de Acesso" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full bg-main border border-border-main rounded-lg p-3 text-text-main text-center focus:border-[#B11226] outline-none mb-4 transition-colors"
                                />
                                <button onClick={handleLogin} className="w-full bg-[#B11226] text-white font-bold uppercase py-3 rounded-lg hover:bg-red-700 transition-all active:scale-95 shadow-lg">Entrar</button>
                                <button onClick={handleForgotPassword} className="text-text-muted text-xs hover:text-text-main underline mt-4">Esqueci minha senha</button>
                            </div>
                        </div>
                    ) : (
                        <>
                            <Sidebar />
                            
                            <main className="flex-1 p-4 md:p-8 md:ml-64 pb-24 md:pb-8 overflow-y-auto h-screen">
                                <header className="flex justify-between items-center mb-8">
                                    <h1 className="font-display text-3xl font-bold uppercase text-text-main">
                                        {view === 'dashboard' && 'Visão Geral'}
                                        {view === 'kanban' && 'Gestão de Pedidos'}
                                        {view === 'menu' && 'Gerenciar Cardápio'}
                                        {view === 'promotions' && 'Gerenciar Promoções'}
                                        {view === 'customers' && 'Base de Clientes'}
                                        {view === 'financial' && 'Relatório Financeiro'}
                                        {view === 'history' && 'Histórico de Vendas'}
                                        {view === 'settings' && 'Configurações'}
                                    </h1>
                                    <div className="text-xs text-text-muted font-mono">v2.0.0</div>
                                </header>

                                {view === 'dashboard' && <DashboardView />}
                                {view === 'kanban' && <KanbanView />}
                                {view === 'menu' && MenuView()}
                                {view === 'promotions' && <PromotionsView />}
                                {view === 'customers' && <CustomersView />}
                                {view === 'financial' && <FinancialView />}
                                {view === 'history' && <HistoryView />}
                                {view === 'settings' && <SettingsView />}
                            </main>

                            {isAddModalOpen && (
                                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setIsAddModalOpen(false)}></div>
                                    <div className="relative w-full max-w-sm bg-card rounded-xl p-6 border border-border-main shadow-2xl animate-fade-in transition-colors duration-300">
                                        <h3 className="font-display text-xl font-bold uppercase text-text-main mb-4">Novo Produto</h3>
                                        <div className="space-y-4">
                                            <select 
                                                value={addProductForm.category_id} 
                                                onChange={e => setAddProductForm({...addProductForm, category_id: parseInt(e.target.value)})}
                                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none transition-colors duration-300"
                                            >
                                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                            <input 
                                                placeholder="Nome" 
                                                value={addProductForm.name}
                                                onChange={e => setAddProductForm({...addProductForm, name: e.target.value})}
                                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none transition-colors duration-300"
                                            />
                                            <input 
                                                type="number"
                                                placeholder="Preço" 
                                                value={addProductForm.price}
                                                onChange={e => setAddProductForm({...addProductForm, price: parseFloat(e.target.value)})}
                                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none transition-colors duration-300"
                                            />
                                            <textarea 
                                                placeholder="Descrição" 
                                                value={addProductForm.description}
                                                onChange={e => setAddProductForm({...addProductForm, description: e.target.value})}
                                                className="w-full bg-main border border-border-main rounded p-3 text-text-main focus:border-[#B11226] outline-none h-20 resize-none transition-colors duration-300"
                                            />
                                            <div className="flex gap-2 mt-4">
                                                <button onClick={() => setIsAddModalOpen(false)} className="flex-1 bg-transparent border border-border-main text-text-main font-bold uppercase py-3 rounded hover:bg-element transition-colors">Cancelar</button>
                                                <button onClick={() => handleAddProduct({...addProductForm, available: true, featured: false})} className="flex-1 bg-[#B11226] text-white font-bold uppercase py-3 rounded hover:bg-red-700">Salvar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <DeleteConfirmModal />
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ToastProvider><App /></ToastProvider>);
    </script>
</body>
</html>
