<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Na Garagem - Hamburgueria Artesanal</title>
    <link rel="icon" type="image/png" href="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/logo%20na%20garagem%20sem%20fundo%20(2).png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS (Essencial para Auth e Storage) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configura√ß√£o do Tailwind para a Marca -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            black: "#0B0B0B",
                            red: "#B11226",
                            white: "#F5F5F5",
                            gray: "#1F1F1F",
                            amber: "#FFBF00", // Amarelo √Çmbar (Brasa)
                        },
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        display: ["Oswald", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <style>
        body { 
            background-color: #0B0B0B;
            background-image: 
                linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.85)),
                url('https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/Design%20sem%20nome%20(5).jpg?v=2');
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
            color: #F5F5F5; min-height: 100vh; 
        }
        @media (max-width: 768px) {
            body { background-position: center top; }
        }
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0B0B0B; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #B11226; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slideInLeft { animation: slideInLeft 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        /* Esconder scrollbar mas manter funcionalidade */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. PROTE√á√ÉO CONTRA FILE:// ---
        console.log(`[DEBUG_ENV] Protocolo detectado: ${window.location.protocol}`);
        if (window.location.protocol === 'file:') {
            console.warn("AVISO: Rodando via file://. Algumas funcionalidades podem ser limitadas. Recomendado: HTTP/HTTPS.");
        }

        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SUPABASE_CONFIG = {
            url: 'https://zgeyjrmnkisomdlugupm.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnZXlqcm1ua2lzb21kbHVndXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMDU5MjEsImV4cCI6MjA4NDg4MTkyMX0.UK5O__2vwehjEQYGaPW3E2rPZZkiTFtXoWNJVKnmoLQ',
            get client() {
                if (typeof window.supabase === 'undefined') {
                    console.error("[DEBUG_SUPABASE] window.supabase is undefined. Verifique o script CDN.");
                    return null;
                }
                const client = window.supabase.createClient(this.url, this.key);
                console.log("[DEBUG_SUPABASE] Client inicializado com sucesso.");
                return client;
            }
        };

        // Inicializa cliente global para compatibilidade
        const supabase = SUPABASE_CONFIG.client;

        // --- 2. FUN√á√ÉO CENTRALIZADA DE FETCH (CORRE√á√ÉO 401) ---
        async function supabaseFetch(endpoint, options = {}) {
            const { method = 'GET', body = null, headers = {}, useUserToken = false } = options;
            
            try {
                const url = `${SUPABASE_CONFIG.url}/rest/v1/${endpoint}`;
                
                // Headers Padr√£o
                const requestHeaders = {
                    'apikey': SUPABASE_CONFIG.key,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation',
                    ...headers
                };

                // L√≥gica de Autoriza√ß√£o:
                // Padr√£o: Usa ANON KEY (para produtos, categorias, etc - evita erro 401 se token de user expirar)
                // Opcional: Usa TOKEN DE USU√ÅRIO se useUserToken=true (para pedidos, perfil)
                let token = SUPABASE_CONFIG.key;
                if (useUserToken) {
                    const session = JSON.parse(localStorage.getItem('garage_session') || '{}');
                    if (session.access_token) token = session.access_token;
                }
                requestHeaders['Authorization'] = `Bearer ${token}`;

                const fetchOptions = {
                    method,
                    headers: requestHeaders,
                };
                if (body) fetchOptions.body = JSON.stringify(body);

                // console.log(`[SUPABASE_FETCH] ${method} ${url}`); // Debug opcional
                const response = await fetch(url, fetchOptions);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå [SUPABASE_ERROR] ${response.status} ${response.statusText}`);
                    console.error(`üîó URL: ${url}`);
                    console.error(`üìÑ Body: ${errorText}`);
                    throw new Error(`Erro Supabase ${response.status}: ${errorText}`);
                }

                if (response.status === 204) return null; // No Content
                return await response.json();
            } catch (error) {
                console.error(`[SUPABASE_FETCH_FATAL]`, error);
                return null;
            }
        }

        // Helper para Auth REST
        async function supabaseAuth(endpoint, body) {
            const url = `${SUPABASE_CONFIG.url}/auth/v1/${endpoint}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_CONFIG.key, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.msg || data.error_description || 'Erro de autentica√ß√£o');
            return data;
        }

        // --- TOAST CONTEXT ---
        const ToastContext = createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 4000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed top-4 left-4 right-4 md:left-auto md:right-4 z-[100] flex flex-col gap-2 pointer-events-none items-center md:items-end">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`pointer-events-auto w-full max-w-sm p-4 rounded shadow-2xl text-white flex justify-between items-center transform transition-all duration-300 animate-slideIn ${
                                toast.type === 'error' ? 'bg-[#B11226] border border-red-800' : 'bg-green-700 border border-green-600'
                            }`}>
                                <div className="flex items-center gap-3">
                                    {toast.type === 'error' ? (
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    ) : (
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    )}
                                    <span className="font-bold text-sm">{toast.message}</span>
                                </div>
                                <button onClick={() => removeToast(toast.id)} className="ml-4 hover:text-gray-300">&times;</button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => useContext(ToastContext);

        // --- √çCONES SVG ---
        // --- HELPERS DE USU√ÅRIO (CORRE√á√ÉO DO CRASH CHARAT) ---
        const getUserDisplayName = (u) => {
            if (!u) return "Visitante";
            return (u.name || u.user_metadata?.name || u.email || "Cliente").trim();
        };

        const getUserInitial = (u) => {
            const name = getUserDisplayName(u);
            return name.charAt(0).toUpperCase() || "C";
        };

        const IconEdit = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const IconTrash = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconUpload = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconStar = ({ filled }) => <svg width="16" height="16" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;

        // --- COMPONENTES DE UI ---
        const NewsletterBanner = ({ onClose, onRegister }) => (
            <div className="fixed bottom-4 right-4 z-[90] max-w-sm w-full bg-[#B11226] p-6 rounded-xl shadow-2xl border border-red-800 animate-fade-in mx-4 md:mx-0">
                <button onClick={onClose} className="absolute top-2 right-2 text-white/60 hover:text-white text-xl">&times;</button>
                <h3 className="font-display text-lg font-bold uppercase text-white mb-2">Ganhe Benef√≠cios!</h3>
                <p className="text-white/90 text-xs mb-4">Crie sua conta e fa√ßa parte do nosso Grupo de Fidelidade! Ganhe benef√≠cios exclusivos em cada pedido.</p>
                <button onClick={onRegister} className="w-full bg-white text-[#B11226] font-bold uppercase py-3 rounded shadow hover:bg-gray-100 transition-colors text-xs">
                    Quero Participar
                </button>
            </div>
        );

        // --- COMPONENTES EXTRA√çDOS (Para evitar re-renderiza√ß√µes e erros de Hook) ---
        
        const LoyaltyCard = ({ user, onRedeem }) => {
            const { addToast } = useToast();
            
            // Hooks devem ser chamados SEMPRE na mesma ordem. N√£o pode haver return antes.
            const points = user ? (user.points || 0) : 0;
            
            // Configura√ß√£o de N√≠veis
            let tier = { name: 'Bronze', gradient: 'from-[#B45309] to-[#78350F]', border: 'border-[#B45309]', text: 'text-amber-200' };
            
            if (points >= 300) {
                tier = { name: 'Ouro', gradient: 'from-[#EAB308] to-[#A16207]', border: 'border-[#EAB308]', text: 'text-yellow-100' };
            } else if (points >= 100) {
                tier = { name: 'Prata', gradient: 'from-[#94A3B8] to-[#475569]', border: 'border-[#94A3B8]', text: 'text-slate-200' };
            }
            
            // Detectar mudan√ßa de n√≠vel
            const [prevTierName, setPrevTierName] = useState(tier.name);

            useEffect(() => {
                if (tier.name !== prevTierName) {
                    const levels = ['Bronze', 'Prata', 'Ouro'];
                    if (levels.indexOf(tier.name) > levels.indexOf(prevTierName)) {
                        addToast(`Subiu de n√≠vel! Bem-vindo ao ${tier.name}! üèÜ`, "success");
                        if (window.confetti) {
                            window.confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 },
                                colors: tier.name === 'Ouro' ? ['#FFD700', '#FFA500'] : ['#C0C0C0', '#FFFFFF']
                            });
                        }
                    }
                    setPrevTierName(tier.name);
                }
            }, [tier.name, prevTierName, addToast]);

            if (!user) return null;

            // Progresso para recompensa (ciclo de 100 pontos)
            const pointsForReward = 100;
            const currentCyclePoints = points % pointsForReward;
            const pointsNeeded = pointsForReward - currentCyclePoints;
            const progress = (currentCyclePoints / pointsForReward) * 100;
            const hasReward = points >= pointsForReward;

            return (
                <div className="mb-6 animate-fade-in">
                    <div className={`bg-gradient-to-r ${tier.gradient} p-5 rounded-xl shadow-lg relative overflow-hidden border ${tier.border} transition-all duration-500`}>
                        <div className="absolute -right-4 -top-4 text-white/10"><svg width="100" height="100" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-end mb-2">
                                <h3 className="font-display font-bold uppercase text-white text-lg leading-none">Fidelidade<br/><span className={`${tier.text} text-sm`}>{tier.name}</span></h3>
                                <div className="text-right"><span className="block text-3xl font-bold text-white leading-none">{points}</span><span className="text-[10px] uppercase text-white/80 font-bold">Pontos</span></div>
                            </div>
                            <div className="w-full bg-black/30 h-2 rounded-full mb-2 overflow-hidden"><div className={`h-full transition-all duration-1000 ease-out ${hasReward ? 'bg-green-400' : 'bg-white'}`} style={{ width: `${hasReward ? 100 : progress}%` }}></div></div>
                            <div className="flex justify-between items-center mt-2">
                                <p className="text-xs text-white/90 font-bold">{hasReward ? "üéâ Recompensa dispon√≠vel!" : `Faltam ${pointsNeeded} pontos para sua recompensa.`}</p>
                                <div className="flex gap-2">
                                    {hasReward && (
                                        <button onClick={() => onRedeem(pointsForReward)} className="bg-white text-[#B11226] text-[10px] font-bold uppercase px-3 py-1.5 rounded shadow hover:bg-gray-100 transition-colors animate-pulse">Resgatar</button>
                                    )}
                                    <button onClick={() => window.dispatchEvent(new CustomEvent('openReferral'))} className="bg-white/20 text-white text-[10px] font-bold uppercase px-3 py-1.5 rounded shadow hover:bg-white/30 transition-colors">Indicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRODUCT CARD (MEMOIZED) ---
        // Extra√≠do para melhorar performance e evitar re-renders desnecess√°rios
        const ProductCard = React.memo(({ product, isFavorite, onToggleFavorite, onAdd, onView }) => {
            // Pre√ßo m√≠nimo para exibi√ß√£o (caso tenha varia√ß√µes)
            const displayPrice = useMemo(() => {
                if (product.variant_prices && Object.keys(product.variant_prices).length > 0) {
                    return Math.min(...Object.values(product.variant_prices));
                }
                return product.price;
            }, [product.variant_prices, product.price]);

            return (
                <div className="bg-[#121212] rounded-xl border border-white/5 flex flex-col hover:shadow-2xl hover:shadow-red-900/10 transition-all duration-300 group relative overflow-hidden h-full">
                    {/* Image Top */}
                    <div className="relative h-32 md:h-48 overflow-hidden cursor-pointer" onClick={() => onView(product)}>
                        {product.image_url ? (
                            <img 
                                src={product.image_url} 
                                className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" 
                                loading="lazy" 
                                decoding="async"
                                alt={product.name}
                            />
                        ) : (
                            <div className="w-full h-full bg-[#1a1a1a] flex items-center justify-center text-gray-700"><span className="font-display uppercase text-xs">Sem Foto</span></div>
                        )}
                        <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onToggleFavorite(product.id); }}
                            className={`absolute top-2 right-2 z-10 p-1.5 rounded-full bg-black/40 backdrop-blur-sm hover:bg-black/80 transition-colors ${isFavorite ? 'text-[#B11226]' : 'text-white'}`}
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill={isFavorite ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                    </div>
                    
                    {/* Content */}
                    <div className="p-3 md:p-5 flex flex-col flex-1 bg-black/60 backdrop-blur-md border-t border-white/5">
                        <h3 className="font-display text-sm md:text-xl font-bold uppercase text-white tracking-wider leading-tight mb-1 line-clamp-1">{product.name}</h3>
                        <p className="text-gray-400 text-xs md:text-sm font-sans leading-relaxed mb-3 line-clamp-2 flex-grow">{product.description}</p>
                        <div className="flex flex-col md:flex-row items-start md:items-center justify-between mt-auto gap-2 md:gap-3">
                            <span className="text-brand-amber font-display font-bold text-lg md:text-2xl drop-shadow-sm">
                                {product.variant_prices && Object.keys(product.variant_prices).length > 0 && <span className="text-[10px] text-gray-500 block leading-none">A partir de</span>}
                                R$ {displayPrice.toFixed(2)}
                            </span>
                            <button 
                                onClick={(e) => onAdd(product, e)}
                                className="w-full md:w-auto bg-white text-black font-display font-bold uppercase px-4 py-2 rounded-lg hover:bg-[#B11226] hover:text-white transition-all duration-300 active:scale-95 shadow-lg text-xs md:text-sm"
                            >
                                Adicionar
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // --- COMPONENTE PRINCIPAL (APP) ---
        const App = () => {
            const { addToast } = useToast();
            const [authMode, setAuthMode] = useState(null); // 'login', 'register', 'forgotPassword'
            const [view, setView] = useState('client'); 
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            const [reviews, setReviews] = useState([]);
            const [variantGroups, setVariantGroups] = useState([]);
            const [promotions, setPromotions] = useState([]);
            const [cart, setCart] = useState([]);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [loading, setLoading] = useState(false);
            const [customerName, setCustomerName] = useState('');
            const [customerAddress, setCustomerAddress] = useState('');
            const [deliveryMethod, setDeliveryMethod] = useState('delivery'); // 'delivery' | 'pickup'
            const [paymentMethod, setPaymentMethod] = useState('pix'); // 'pix' | 'card' | 'money'
            const [useNewAddress, setUseNewAddress] = useState(false); // Controle de UI para endere√ßo
            const [changeFor, setChangeFor] = useState('');
            const [user, setUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [favorites, setFavorites] = useState([]);
            const [showFavoritesOnly, setShowFavoritesOnly] = useState(false);
            const [couponCode, setCouponCode] = useState('');
            const [discountPercent, setDiscountPercent] = useState(0);
            const [showComboModal, setShowComboModal] = useState(false);
            const [comboProduct, setComboProduct] = useState(null);
            const [showReferralModal, setShowReferralModal] = useState(false);
            const [orderHistory, setOrderHistory] = useState([]);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [viewProduct, setViewProduct] = useState(null);
            const [activeCategory, setActiveCategory] = useState(null);
            const [storeSettings, setStoreSettings] = useState({
                manualOverride: false, // se true, usa isOpenManual
                isOpenManual: true,
                status: 'open', // open, closed, pickup_only
                phone: '5511999999999',
                openTime: '19:00',
                closeTime: '23:00'
            });
            const [isCategoryDropdownOpen, setIsCategoryDropdownOpen] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [showNewsletter, setShowNewsletter] = useState(false);
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [showPrivacyModal, setShowPrivacyModal] = useState(false);
            
            // --- TAREFA C: SCROLL LOCK ---
            // Trava o scroll do body quando o carrinho est√° aberto
            useEffect(() => {
                if (isCartOpen) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'unset';
                }
                return () => { document.body.style.overflow = 'unset'; };
            }, [isCartOpen]);

            // --- CONTROLE DE EXIBI√á√ÉO MOBILE (LIMITAR 4 ITENS) ---
            const [isMobile, setIsMobile] = useState(typeof window !== 'undefined' ? window.innerWidth < 768 : false);
            const [expandedCategories, setExpandedCategories] = useState({});

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // --- CHECK DE INICIALIZA√á√ÉO ---
            if (!supabase) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-[#0B0B0B] text-[#F5F5F5] p-4 text-center">
                        <div className="text-[#B11226] text-6xl mb-4">‚ö†Ô∏è</div>
                        <h1 className="text-2xl font-bold mb-2">Erro de Conex√£o</h1>
                        <p className="text-gray-400 mb-6">N√£o foi poss√≠vel carregar os servi√ßos do Supabase.</p>
                        <button onClick={() => window.location.reload()} className="bg-[#B11226] text-white px-6 py-3 rounded font-bold uppercase hover:bg-red-700 transition-colors">Tentar Novamente</button>
                    </div>
                );
            }

            // --- FUN√á√ÉO DE RESGATE DE PONTOS (CORRE√á√ÉO DO ERRO) ---
            const handleRedeemPoints = async (cost) => {
                console.log('Processando resgate de pontos:', cost);
                if (!user) return;
                if ((user.points || 0) < cost) {
                    addToast("Pontos insuficientes!", "error");
                    return;
                }

                const newPoints = (user.points || 0) - cost;
                
                // Atualiza estado local (Otimista)
                setUser(prev => ({ ...prev, points: newPoints }));

                // Atualiza no Supabase
                if (supabase) {
                    const { error } = await supabase.from('usuarios').update({ points: newPoints }).eq('id', user.id);
                    if (error) {
                        console.error("Erro ao resgatar:", error);
                        addToast("Erro ao processar resgate.", "error");
                        setUser(prev => ({ ...prev, points: user.points })); // Reverte
                    } else {
                        addToast("Recompensa resgatada! Mostre ao caixa.", "success");
                        if (window.confetti) window.confetti();
                    }
                }
            };

            const handleAddPoints = async (pointsToAdd) => {
                if (!user) return;
                const newPoints = (user.points || 0) + pointsToAdd;
                setUser(prev => ({ ...prev, points: newPoints }));
                const { error } = await supabase.from('usuarios').update({ points: newPoints }).eq('id', user.id);
                if (error) {
                    addToast("Erro ao adicionar pontos.", "error");
                    setUser(prev => ({ ...prev, points: user.points })); // Reverte
                } else {
                    addToast(`+${pointsToAdd} pontos adicionados!`, "success");
                }
            };

            // --- FUN√á√ÉO DE CONFETE ---
            const triggerConfetti = (e) => {
                if (!e || !e.target) return;
                const rect = (e.currentTarget || e.target).getBoundingClientRect(); // Fix: currentTarget garante que pegamos o bot√£o, n√£o o SVG interno
                const x = (rect.left + rect.width / 2) / window.innerWidth;
                const y = (rect.top + rect.height / 2) / window.innerHeight;
                
                if (window.confetti) {
                    window.confetti({
                        particleCount: 60,
                        spread: 70,
                        origin: { x, y },
                        colors: ['#B11226', '#F5F5F5', '#121212'],
                        zIndex: 100
                    });
                }
            };

            const isStoreOpen = () => {
                // Se o status estiver definido no banco, ele manda.
                if (storeSettings.status === 'closed') return false;
                if (storeSettings.status === 'open' || storeSettings.status === 'pickup_only') return true;
                
                // Fallback para hor√°rio se n√£o tiver status (opcional, mas o admin agora controla tudo)
                return true; 
            };

            // --- L√ìGICA DO CARRINHO ---
            const addToCart = (product) => {
                try {
                    if (!product || !product.id) throw new Error("Produto inv√°lido");
                    
                    // Fix: Garantir que pre√ßo √© n√∫mero
                    let safePrice = product.price;
                    if (typeof safePrice === 'string') {
                        safePrice = parseFloat(safePrice.replace(',', '.'));
                    }
                    if (isNaN(safePrice)) safePrice = 0;

                    const safeProduct = { ...product, price: safePrice };

                    setCart(prev => {
                        const existing = prev.find(p => p.id === safeProduct.id);
                        if (existing) return prev.map(p => p.id === safeProduct.id ? { ...p, quantity: p.quantity + 1 } : p);
                        return [...prev, { ...safeProduct, quantity: 1 }];
                    });
                    if (cart.length === 0) setIsCartOpen(true);
                    else addToast("Adicionado ao carrinho!", "success");
                } catch (error) {
                    console.error("Erro ao adicionar ao carrinho:", error);
                    addToast("Erro ao adicionar item.", "error");
                }
            };

            const handleProductClick = (product, e) => {
                // Se tiver op√ß√£o de Ponto da Carne (ex: Burger), oferece Combo
                if (product.has_doneness) {
                    setComboProduct(product);
                    setShowComboModal(true);
                } else {
                    if (e) triggerConfetti(e);
                    addToCart(product);
                }
            };

            const removeFromCart = (id) => setCart(prev => prev.filter(p => p.id !== id));
            
            const updateQuantity = (id, delta) => {
                setCart(prev => prev.map(p => {
                    if (p.id === id) return { ...p, quantity: Math.max(1, p.quantity + delta) };
                    return p;
                }));
            };

            const updateObservation = (id, text) => {
                setCart(prev => prev.map(p => {
                    if (p.id === id) return { ...p, observation: text };
                    return p;
                }));
            };

            const applyCoupon = () => {
                if (couponCode.toUpperCase() === 'PRIMEIRACOMPRA') {
                    setDiscountPercent(0.10);
                    addToast("Cupom de 10% aplicado!", "success");
                    if (window.confetti) {
                        window.confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                } else {
                    setDiscountPercent(0);
                    addToast("Cupom inv√°lido.", "error");
                }
            };

            const subTotal = useMemo(() => cart.reduce((acc, item) => acc + (item.price * item.quantity), 0), [cart]);
            const discountValue = subTotal * discountPercent;
            const cartTotal = subTotal - discountValue;

            // (B) Endere√ßo Salvo (Memoizado para performance)
            const savedAddress = useMemo(() => {
                if (!user) return '';
                const parts = [user.street, user.number, user.neighborhood, user.complement, user.cep].filter(Boolean);
                return parts.length > 0 ? parts.join(', ') : (user.address || '');
            }, [user]);

            const checkoutWhatsApp = async () => {
                if (!isStoreOpen()) {
                    addToast("A loja est√° fechada! Hor√°rio: 19:00 √†s 23:00 (Qui a Ter)", "error");
                    return;
                }
                
                if (storeSettings.status === 'pickup_only' && deliveryMethod === 'delivery') {
                    addToast("No momento estamos aceitando apenas Retirada!", "error");
                    return;
                }

                const phone = storeSettings.phone;
                let msg = "Fala, Garagem! Pedido via Site:\n\n";
                if (customerName) msg += `üë§ *Nome:* ${customerName}\n`;
                if (user && user.phone) msg += `üì± *Tel:* ${user.phone}\n`;
                
                if (deliveryMethod === 'delivery') {
                    msg += `üõµ *Entrega:* Sim\n`;
                    if (customerAddress) msg += `üìç *Endere√ßo:* ${customerAddress}\n\n`;
                } else {
                    msg += `üõçÔ∏è *Retirada:* Sim (No Local)\n\n`;
                }

                cart.forEach(item => {
                    msg += `‚ñ™Ô∏è ${item.quantity}x ${item.name}\n`;
                    if (item.variant_label) msg += `   üîπ Op√ß√£o: ${item.variant_label}\n`;
                    if (item.doneness) msg += `   ü•© Ponto: ${item.doneness}\n`;
                    if (item.observation) msg += `   üìù Obs: ${item.observation}\n`;
                });
                
                msg += `\nüßæ Subtotal: R$ ${subTotal.toFixed(2)}`;
                if (discountPercent > 0) {
                    msg += `\nüè∑Ô∏è Desconto: -R$ ${discountValue.toFixed(2)}`;
                }
                msg += `\nüí∞ *Total Final: R$ ${cartTotal.toFixed(2)}*`;
                
                const paymentLabels = { pix: 'Pix', card: 'Cart√£o', money: 'Dinheiro' };
                msg += `\nüí≥ *Pagamento:* ${paymentLabels[paymentMethod]}`;
                if (paymentMethod === 'money' && changeFor) msg += `\nüíµ *Troco para:* R$ ${changeFor}`;
                
                // Salvar no Supabase
                const newOrder = {
                    user_id: user ? user.id : null, // Vincula o pedido ao usu√°rio logado
                    customer: customerName,
                    phone: user?.phone || 'N√£o informado',
                    address: deliveryMethod === 'delivery' ? customerAddress : 'Retirada',
                    payment: paymentMethod,
                    delivery_fee: 0, // Ajustar se tiver taxa
                    total: cartTotal,
                    status: 'Na Cozinha',
                    items: cart,
                    created_at: new Date().toISOString()
                };

                // Salvar no Supabase
                await supabaseRequest('orders', 'POST', newOrder);

                // Salvar ou Atualizar Cliente no Supabase
                if (user && user.phone) {
                    // Upsert via REST (requer header Prefer: resolution=merge-duplicates)
                    await supabaseRequest('customers', 'POST', {
                        phone: user.phone,
                        name: customerName,
                        address: customerAddress,
                        last_order_at: new Date().toISOString()
                    }, { 'Prefer': 'resolution=merge-duplicates' });
                }

                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                
                // Limpar carrinho
                setCart([]);
                setIsCartOpen(false);
                
                // Simula√ß√£o de Fidelidade
                if (user) {
                    const pointsEarned = Math.floor(cartTotal);
                    const newPoints = (user.points || 0) + pointsEarned;
                    setUser(prev => ({ ...prev, points: newPoints }));
                    addToast(`Pedido enviado! Voc√™ ganhou ${pointsEarned} pontos! üéâ`, "success");
                }
            };

            const handleRepeatOrder = (items) => {
                setCart(items);
                setIsCartOpen(true);
                setShowHistoryModal(false);
                addToast("Itens adicionados ao carrinho!", "success");
            };

            const handleRepeatLastOrder = async () => {
                if (!user) return;
                setLoading(true);
                try {
                    const orders = await supabaseFetch(`orders?select=*&user_id=eq.${user.id}&order=created_at.desc&limit=1`, { useUserToken: true });
                    if (!orders || orders.length === 0) {
                        addToast("Nenhum pedido anterior encontrado.", "error");
                    } else {
                        setCart(orders[0].items);
                        setIsCartOpen(true);
                        addToast("√öltimo pedido carregado!", "success");
                    }
                } catch (e) {
                    console.error(e);
                    addToast("Erro ao buscar pedido.", "error");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (user) {
                    setCustomerName(user.name || '');
                    if (user.addressString) setCustomerAddress(user.addressString);
                }
            }, [user]);

            // --- L√ìGICA DA NEWSLETTER ---
            useEffect(() => {
                const newsletterShown = localStorage.getItem('newsletter_exibida');
                // Mostra apenas se n√£o foi exibida e usu√°rio n√£o est√° logado
                if (!newsletterShown && !user) {
                    const timer = setTimeout(() => setShowNewsletter(true), 3000); // Delay de 3s
                    return () => clearTimeout(timer);
                }
            }, [user]);

            const handleCloseNewsletter = () => {
                setShowNewsletter(false);
                localStorage.setItem('newsletter_exibida', 'true');
            };

            const handleRegisterNewsletter = () => {
                handleCloseNewsletter();
                setAuthMode('register');
            };

            // --- L√ìGICA DO ADMIN ---
            // Carregar dados reais se houver Supabase
            useEffect(() => {
                fetchData();
                
                // Auth Listener Robusto
                if (supabase) {
                    supabase.auth.getSession().then(({ data: { session } }) => {
                        if (session?.user) {
                            checkSession(session.user);
                        }
                    });

                    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                        if (session?.user) {
                            checkSession(session.user);
                        } else {
                            setUser(null);
                        }
                    });
                    return () => subscription.unsubscribe();
                }
            }, []);

            const checkSession = async (authUser) => {
                console.log("[DEBUG_AUTH] Verificando sess√£o para:", authUser.email);
                let profile = {};
                try {
                    const profiles = await supabaseFetch(`usuarios?id=eq.${authUser.id}&select=*`, { useUserToken: true });
                    if (profiles && profiles.length > 0) profile = profiles[0];
                } catch (e) { console.warn("[DEBUG_AUTH] Erro ao buscar perfil:", e); }
                
                // Atualiza User e for√ßa re-render
                const safeUser = { ...authUser, ...profile };
                if (!safeUser.name) safeUser.name = getUserDisplayName(safeUser);
                setUser(safeUser);
            };

            const setupRealtime = () => {
                console.log("[DEBUG_SUPABASE_LOAD] Realtime desativado no modo REST.");
            };

            const fetchData = async () => {
                setLoading(true);
                console.log("[DEBUG_SUPABASE] Iniciando fetchData...");
                
                // 1. Categorias (For√ßando a ordem fixa solicitada)
                const defaultCats = [
                    { id: 2, name: 'HAMBURGUERES' },
                    { id: 3, name: 'CHICKEN' },
                    { id: 4, name: 'POR√á√ïES' },
                    { id: 5, name: 'CACHORRO QUENTE' },
                    { id: 6, name: 'PASTEIS' },
                    { id: 7, name: 'SOBREMESAS' },
                    { id: 8, name: 'BEBIDAS' },
                    { id: 9, name: 'Adicionais' },
                    { id: 10, name: 'Combo Artesanal' },
                    { id: 11, name: 'Fritas' }
                ];
                
                // Tenta buscar categorias do banco se dispon√≠vel
                try {
                    const cats = await supabaseFetch('categories?select=*&order=display_order.asc');
                    if (cats && cats.length > 0) {
                        // --- PROTE√á√ÉO CONTRA DUPLICIDADE ---
                        const uniqueCats = [];
                        const seen = new Set();

                        cats.forEach(cat => {
                            let name = cat.name.trim().toUpperCase();
                            if (name === 'BURGERS') name = 'HAMBURGUERES'; // Mapeia visualmente

                            if (!seen.has(name)) {
                                seen.add(name);
                                uniqueCats.push({ ...cat, name }); // Usa o nome unificado
                            }
                        });

                        // For√ßa HAMBURGUERES para o topo da lista
                        uniqueCats.sort((a, b) => {
                            if (a.name === 'HAMBURGUERES') return -1;
                            if (b.name === 'HAMBURGUERES') return 1;
                            return (a.display_order || 99) - (b.display_order || 99);
                        });

                        setCategories(uniqueCats);
                        setActiveCategory(uniqueCats[0].id);
                    } else {
                        setCategories(defaultCats);
                        setActiveCategory(defaultCats[0].id);
                    }
                } catch (e) {
                    setCategories(defaultCats);
                    setActiveCategory(defaultCats[0].id);
                }

                // 2. Produtos
                try {
                    const prods = await supabaseFetch('products?select=*&order=name.asc');
                    
                    if (prods) {
                        // Normaliza√ß√£o de campos (available/is_active null vira true)
                        const normalizedProds = prods.map(p => ({
                            ...p,
                            available: p.available !== false, // se null/undefined -> true
                            is_active: p.is_active !== false
                        }));

                        console.log(`[DEBUG_PRODUCTS] Total carregado: ${normalizedProds.length}`);
                        console.log(`[DEBUG_PRODUCTS] Vis√≠veis: ${normalizedProds.filter(p => p.available).length}`);

                        setProducts(normalizedProds);
                    }
                } catch (e) { console.error("Erro ao buscar produtos:", e); }

                // 2.1 Grupos de Varia√ß√£o
                try {
                    const vgs = await supabaseFetch('variant_groups?select=*');
                    if (vgs) setVariantGroups(vgs);
                } catch (e) { console.warn("Erro ao buscar varia√ß√µes:", e); }

                // 3. Promo√ß√µes
                try {
                    const promos = await supabaseFetch('promotions?select=*&active=eq.true');
                    if (promos) setPromotions(promos);
                } catch (e) { 
                    console.warn("Promo√ß√µes n√£o carregadas (tabela pode n√£o existir ou erro de conex√£o):", e); 
                }

                // 4. Configura√ß√µes
                try {
                    const settingsArr = await supabaseFetch('settings?select=*&limit=1');
                    if (settingsArr && settingsArr.length > 0) {
                        const settings = settingsArr[0];
                        setStoreSettings(prev => ({ ...prev, ...settings, isOpenManual: settings.is_open }));
                    }
                } catch (e) { console.warn("Erro ao buscar settings:", e); }

                setLoading(false);
            };

            const handleAddReview = (reviewData) => {
                const newReview = {
                    id: Date.now(),
                    ...reviewData,
                    reply: null
                };
                setReviews(prev => [newReview, ...prev]);
                addToast("Avalia√ß√£o enviada! Obrigado.", "success");
            };

            const toggleFavorite = (id) => {
                setFavorites(prev => prev.includes(id) ? prev.filter(favId => favId !== id) : [...prev, id]);
            };

            // --- MODAL DE DETALHES DO PRODUTO ---
            const ProductDetailsModal = ({ product, onClose, onAdd }) => {
                const [doneness, setDoneness] = useState('Ao Ponto');
                const [selectedVariant, setSelectedVariant] = useState(null);
                
                // L√≥gica de Varia√ß√£o (Baseada no Grupo do Banco)
                const variantGroup = useMemo(() => {
                    if (product.variant_group_id && variantGroups.length > 0) {
                        return variantGroups.find(vg => vg.id === product.variant_group_id);
                    }
                    return null;
                }, [product, variantGroups]);

                const variantOptions = useMemo(() => {
                    if (!variantGroup || !product.variant_prices) return [];
                    // Filtra apenas op√ß√µes que t√™m pre√ßo definido no produto
                    return variantGroup.options.filter(o => product.variant_prices[o.id] !== undefined && product.variant_prices[o.id] !== null);
                }, [variantGroup, product]);
                
                // Pre√ßo Din√¢mico
                const currentPrice = useMemo(() => {
                    if (selectedVariant && product.variant_prices) {
                        return product.variant_prices[selectedVariant] || product.price;
                    }
                    return product.price;
                }, [selectedVariant, product]);

                const handleAddToCart = (e) => {
                    if (variantOptions.length > 0 && !selectedVariant) {
                        addToast("Selecione uma op√ß√£o!", "error");
                        return;
                    }
                    
                    const variantInfo = selectedVariant ? {
                        id: selectedVariant,
                        label: variantOptions.find(o => o.id === selectedVariant)?.label,
                        price: product.variant_prices[selectedVariant]
                    } : null;

                    onAdd({ 
                        ...product, 
                        price: variantInfo ? variantInfo.price : currentPrice, 
                        doneness: product.has_doneness ? doneness : null,
                        variant_id: variantInfo?.id,
                        variant_label: variantInfo?.label
                    }, e);
                    onClose();
                };

                if (!product) return null;
                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-lg bg-[#1F1F1F] rounded-2xl overflow-hidden shadow-2xl flex flex-col border border-gray-800 animate-fade-in overflow-y-auto max-h-[90vh]">
                            <div className="relative h-48 md:h-64 flex-shrink-0">
                                {product.image_url ? (
                                    <img src={product.image_url} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="w-full h-full bg-[#121212] flex items-center justify-center text-gray-700"><span className="font-display uppercase">Sem Foto</span></div>
                                )}
                                <button onClick={onClose} className="absolute top-4 right-4 bg-black/60 text-white p-2 rounded-full hover:bg-[#B11226] transition-colors backdrop-blur-sm z-10">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                                <div className="absolute inset-0 bg-gradient-to-t from-[#1F1F1F] to-transparent"></div>
                            </div>
                            <div className="p-8">
                                <div className="flex justify-between items-start mb-2">
                                    <h2 className="font-display text-3xl font-bold uppercase text-white leading-tight">{product.name}</h2>
                                    <span className="text-[#B11226] font-display font-bold text-2xl whitespace-nowrap">R$ {currentPrice.toFixed(2)}</span>
                                </div>
                                <div className="flex gap-2 mb-6">
                                    <span className="text-[10px] font-bold uppercase bg-gray-800 text-gray-400 px-2 py-1 rounded">Artesanal</span>
                                    <span className="text-[10px] font-bold uppercase bg-gray-800 text-gray-400 px-2 py-1 rounded">Na Brasa</span>
                                </div>
                                <div className="space-y-6">
                                    <div><h3 className="text-xs font-bold text-[#B11226] uppercase tracking-widest mb-2">Descri√ß√£o</h3><p className="text-gray-300 text-base leading-relaxed font-sans">{product.description}</p></div>
                                    <div><h3 className="text-xs font-bold text-[#B11226] uppercase tracking-widest mb-2">Ingredientes</h3><p className="text-gray-400 text-sm leading-relaxed">Nossos burgers s√£o feitos com blend 100% bovino, mo√≠do diariamente. P√£o brioche selado na manteiga, queijos selecionados e vegetais frescos entregues toda manh√£.</p></div>
                                    
                                    {/* Seletor de Varia√ß√£o */}
                                    {variantOptions.length > 0 && (
                                        <div>
                                            <h3 className="text-xs font-bold text-[#B11226] uppercase tracking-widest mb-2">{variantGroup?.name || 'Escolha uma op√ß√£o'}</h3>
                                            <div className="flex flex-col gap-2">
                                                {variantOptions.map(opt => (
                                                    <label key={opt.id} className={`flex items-center justify-between p-3 rounded border cursor-pointer transition-all ${selectedVariant === opt.id ? 'bg-[#B11226]/20 border-[#B11226]' : 'bg-[#121212] border-gray-700 hover:border-gray-500'}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-4 h-4 rounded-full border flex items-center justify-center ${selectedVariant === opt.id ? 'border-[#B11226]' : 'border-gray-500'}`}>{selectedVariant === opt.id && <div className="w-2 h-2 bg-[#B11226] rounded-full"></div>}</div>
                                                            <span className="text-sm font-bold text-white">{opt.label}</span>
                                                        </div>
                                                        <span className="text-sm font-bold text-white">R$ {product.variant_prices[opt.id].toFixed(2)}</span>
                                                        <input type="radio" name="variant" className="hidden" value={opt.id} checked={selectedVariant === opt.id} onChange={() => setSelectedVariant(opt.id)} />
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {product.has_doneness && (
                                        <div>
                                            <h3 className="text-xs font-bold text-[#B11226] uppercase tracking-widest mb-2">Ponto da Carne</h3>
                                            <div className="flex gap-2">
                                                {['Mal Passado', 'Ao Ponto', 'Bem Passado'].map(p => (
                                                    <button key={p} onClick={() => setDoneness(p)} className={`flex-1 py-3 text-xs font-bold uppercase rounded border transition-colors ${doneness === p ? 'bg-white text-black border-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}>{p}</button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="mt-8 pt-6 border-t border-gray-800">
                                    <button onClick={handleAddToCart} className="w-full bg-[#B11226] text-white font-bold uppercase py-4 rounded-xl hover:bg-red-700 transition-all active:scale-95 shadow-lg flex items-center justify-center gap-2">
                                        <span>Adicionar ao Pedido</span>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const OrderHistoryModal = ({ history, onClose, onRepeat }) => (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-display text-xl font-bold uppercase text-white">Hist√≥rico</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div className="space-y-4">
                            {history.length === 0 ? (
                                <p className="text-gray-400 text-center py-8 text-sm">Nenhum pedido recente.</p>
                            ) : (
                                history.map(order => (
                                    <div key={order.id} className="bg-[#0B0B0B] p-4 rounded border border-gray-800">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <span className="text-[#B11226] font-bold text-[10px] uppercase block mb-1">{order.date}</span>
                                                <p className="text-white font-bold text-sm">Total: R$ {order.total.toFixed(2)}</p>
                                            </div>
                                            <button onClick={() => onRepeat(order.items)} className="text-[10px] font-bold uppercase bg-white text-black px-3 py-1.5 rounded hover:bg-[#B11226] hover:text-white transition-colors">
                                                Repetir
                                            </button>
                                        </div>
                                        <ul className="text-xs text-gray-500 space-y-1 border-t border-gray-800 pt-2">
                                            {order.items.map((item, idx) => (
                                                <li key={idx} className="truncate">‚Ä¢ {item.quantity}x {item.name}</li>
                                            ))}
                                        </ul>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );

            // --- COMPONENTES DE CONTEXTO (NOVO) ---
            const FeaturedCarousel = ({ products, onAdd }) => {
                const featured = products.filter(p => p.featured && p.available);
                if (featured.length === 0) return null;

                return (
                    <div className="mb-10 animate-fade-in">
                        <h3 className="font-display text-xl font-bold uppercase text-white mb-4 flex items-center gap-2 tracking-wider">
                            <span className="text-[#B11226]">üî•</span> Destaques
                        </h3>
                        <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x">
                            {featured.map(p => (
                                <div key={p.id} className="min-w-[220px] bg-[#121212] border border-white/5 rounded-2xl p-0 flex flex-col snap-center hover:shadow-lg hover:shadow-red-900/20 transition-all duration-300 relative group overflow-hidden">
                                    <div className="h-36 bg-black mb-0 overflow-hidden relative cursor-pointer" onClick={() => setViewProduct(p)}>
                                        {p.image_url ? <img src={p.image_url} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-700 text-xs">FOTO</div>}
                                        <div className="absolute top-2 right-2 bg-[#B11226] text-white text-[10px] font-bold px-2 py-1 rounded shadow z-10">TOP</div>
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); toggleFavorite(p.id); }}
                                            className={`absolute top-2 left-2 p-1.5 rounded-full bg-black/50 hover:bg-black transition-colors ${favorites.includes(p.id) ? 'text-[#B11226]' : 'text-white'}`}
                                        >
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill={favorites.includes(p.id) ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                        </button>
                                    </div>
                                    <div className="p-4 flex flex-col flex-1">
                                        <h4 className="font-display text-sm font-bold uppercase mb-1 truncate tracking-wide text-white">{p.name}</h4>
                                        <span className="text-[#B11226] font-bold text-sm mb-3">R$ {p.price.toFixed(2)}</span>
                                        <button 
                                            onClick={(e) => onAdd(p, e)}
                                            className="mt-auto w-full bg-white text-black font-bold text-xs uppercase py-2.5 rounded-xl hover:bg-[#B11226] hover:text-white transition-all active:scale-95"
                                        >
                                            Adicionar
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const ReferralModal = ({ user, onClose, onAddPoints }) => {
                const { addToast } = useToast();
                if (!user) return null;
                const referralCode = user.name ? user.name.split(' ')[0].toLowerCase() + '10' : 'amigo10';
                const link = `https://nagaragem.com.br/?ref=${referralCode}`;

                const handleCopy = () => {
                    navigator.clipboard.writeText(link);
                    addToast("Link copiado!", "success");
                };

                const handleShare = () => {
                    const msg = `Ei! Pede no Na Garagem Burguer usando meu link e ganhe desconto: ${link}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                };
                
                const handleSimulate = () => {
                    onAddPoints(50);
                    if (window.confetti) window.confetti();
                };

                return (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-sm bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in text-center overflow-y-auto max-h-[90vh]"><div className="w-16 h-16 bg-[#B11226]/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-[#B11226]"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#B11226" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg></div><h3 className="font-display text-xl font-bold uppercase text-white mb-2">Indique e Ganhe</h3><p className="text-gray-400 text-sm mb-6">Compartilhe seu link exclusivo. Quando um amigo fizer o primeiro pedido, voc√™ ganha <span className="text-white font-bold">50 pontos</span>!</p><div className="bg-[#0B0B0B] p-3 rounded border border-gray-700 mb-4 flex items-center justify-between"><span className="text-gray-400 text-xs truncate mr-2">{link}</span><button onClick={handleCopy} className="text-[#B11226] font-bold text-xs uppercase hover:text-white">Copiar</button></div><button onClick={handleShare} className="w-full bg-[#25D366] text-white font-bold uppercase py-3 rounded hover:bg-green-600 transition-colors mb-3 flex items-center justify-center gap-2"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> Enviar no WhatsApp</button><button onClick={handleSimulate} className="text-xs text-gray-500 hover:text-white underline mt-2">Simular indica√ß√£o aceita (+50 pts)</button><button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button></div>
                    </div>
                );
            };

            const LoginModal = ({ onClose, onLogin, onCreateAccount, onForgotPassword }) => {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const [keepConnected, setKeepConnected] = useState(true);
                const [loading, setLoading] = useState(false);

                const handleSupabaseLogin = async () => {
                    setLoading(true);
                    // O Supabase persiste por padr√£o (LOCAL), mas podemos for√ßar SESSION se desmarcado
                    try {
                        const data = await supabaseAuth('token?grant_type=password', { email, password });
                        
                        // Salvar sess√£o manualmente (Backup)
                        localStorage.setItem('garage_session', JSON.stringify(data));
                        
                        // O Auth Listener no useEffect vai pegar isso, mas for√ßamos aqui para UI imediata
                        if (data.user) {
                            const profiles = await supabaseFetch(`usuarios?id=eq.${data.user.id}&select=*`, { useUserToken: true });
                            const profile = profiles && profiles.length > 0 ? profiles[0] : {};
                            const safeUser = { ...data.user, ...profile };
                            if (!safeUser.name) safeUser.name = getUserDisplayName(safeUser);
                            onLogin(safeUser);
                            // For√ßa atualiza√ß√£o de dados ap√≥s login
                            fetchData();
                        }
                        onClose();
                    } catch (error) {
                        addToast("Erro ao entrar: " + error.message, "error");
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-sm bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-display text-xl font-bold uppercase text-white">Entrar</h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="seu@email.com" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Senha</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="******" />
                                </div>
                                <div>
                                    <button onClick={onForgotPassword} className="text-xs text-gray-400 hover:text-white underline">Esqueceu sua senha? Clique aqui</button>
                                </div>
                                <div className="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="keepConnected" checked={keepConnected} onChange={e => setKeepConnected(e.target.checked)} className="accent-[#B11226] w-4 h-4 cursor-pointer" />
                                    <label htmlFor="keepConnected" className="text-xs text-gray-400 cursor-pointer select-none">Manter-me conectado</label>
                                </div>
                            </div>
                            <div className="mt-6 flex gap-3">
                                <button onClick={handleSupabaseLogin} disabled={loading} className="flex-1 bg-[#B11226] text-white font-bold uppercase py-3 rounded hover:bg-red-700 transition-colors disabled:opacity-50">{loading ? 'Entrando...' : 'Entrar'}</button>
                                <button onClick={onCreateAccount} className="flex-1 bg-transparent border border-gray-700 text-white font-bold uppercase py-3 rounded hover:bg-gray-800 transition-colors">Criar uma conta</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ForgotPasswordModal = ({ onClose, onBack }) => {
                const [email, setEmail] = useState('');
                const [loading, setLoading] = useState(false);
                const [sent, setSent] = useState(false);

                const handleSubmit = async () => {
                    if (!email) { addToast("Digite seu e-mail.", "error"); return; }
                    
                    setLoading(true);
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin, // Link para onde o usu√°rio volta ap√≥s resetar
                    });
                    setLoading(false);

                    if (error) {
                        addToast("Erro ao enviar e-mail: " + error.message, "error");
                    } else {
                        setSent(true);
                    }
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-sm bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-display text-xl font-bold uppercase text-white">Recuperar Senha</h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            {!sent ? (
                                <div className="space-y-4">
                                    <p className="text-gray-400 text-sm">Digite seu e-mail para receber um link de redefini√ß√£o de senha.</p>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail</label>
                                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="seu@email.com" />
                                    </div>
                                    <button onClick={handleSubmit} disabled={loading} className="w-full bg-[#B11226] text-white font-bold uppercase py-3 rounded hover:bg-red-700 transition-colors mt-2 disabled:opacity-50">{loading ? 'Enviando...' : 'Enviar Link'}</button>
                                    <button onClick={onBack} className="w-full text-gray-400 text-sm hover:text-white mt-2">Voltar para o Login</button>
                                </div>
                            ) : (
                                <div className="text-center space-y-4">
                                    <div className="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto text-green-500 border border-green-900">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    </div>
                                    <h4 className="font-bold text-white">E-mail enviado!</h4>
                                    <p className="text-gray-400 text-sm">Verifique sua caixa de entrada para redefinir sua senha.</p>
                                    <button onClick={onClose} className="w-full bg-gray-800 text-white font-bold uppercase py-3 rounded hover:bg-gray-700 transition-colors">Fechar</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const RegistrationModal = ({ onClose, onSave }) => {
                const [formData, setFormData] = useState({
                    email: '', password: '', name: '', phone: '', cep: '', street: '', number: '', neighborhood: '', complement: ''
                });
                const [loading, setLoading] = useState(false);

                const handleChange = (e) => {
                    let { name, value } = e.target;
                    
                    if (name === 'phone') {
                        // Remove tudo que n√£o √© d√≠gito
                        value = value.replace(/\D/g, '');
                        // Limita a 11 d√≠gitos
                        value = value.slice(0, 11);
                        
                        // Aplica a m√°scara (XX) XXXXX-XXXX
                        if (value.length > 10) {
                            value = value.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                        } else if (value.length > 6) {
                            value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                        } else if (value.length > 2) {
                            value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
                        } else if (value.length > 0) {
                            value = value.replace(/^(\d{0,2})/, '($1');
                        }
                    }
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = async () => {
                    if (!formData.email || !formData.password || !formData.name || !formData.phone) { 
                        addToast("Preencha os campos obrigat√≥rios (*)", "error"); 
                        return; 
                    }
                    
                    setLoading(true);
                    // 1. Cria o usu√°rio na Auth
                    try {
                        const data = await supabaseAuth('signup', {
                            email: formData.email,
                            password: formData.password,
                            data: { 
                                name: formData.name, 
                                phone: formData.phone, // Salva como WhatsApp
                                birth_date: formData.birthDate,
                                cep: formData.cep,
                                neighborhood: formData.neighborhood
                            }
                        });

                        // 2. Garante persist√™ncia na tabela 'usuarios' (Upsert para evitar conflito com Trigger)
                        if (data?.user) {
                            // Upsert via REST
                            await supabaseFetch('usuarios', { 
                                method: 'POST', 
                                body: {
                                id: data.user.id,
                                email: formData.email,
                                name: formData.name,
                                phone: formData.phone, // Salva como WhatsApp
                                birth_date: formData.birthDate,
                                cep: formData.cep,
                                neighborhood: formData.neighborhood,
                                fidelidade_ativo: true // Ativa fidelidade
                                },
                                headers: { 'Prefer': 'resolution=merge-duplicates' },
                                useUserToken: true
                            });
                        }

                        const newUser = {
                            id: data.user?.id,
                            email: formData.email,
                            name: formData.name,
                            phone: formData.phone, // Salva como WhatsApp
                            birth_date: formData.birthDate,
                            cep: formData.cep,
                            neighborhood: formData.neighborhood,
                            fidelidade_ativo: true,
                            points: 0
                        };

                        // Auto-login ap√≥s cadastro
                        localStorage.setItem('garage_session', JSON.stringify(data));
                        
                        addToast("Conta criada com sucesso!", "success");
                        onSave(newUser);
                        onClose();
                    } catch (error) {
                        addToast("Erro no cadastro: " + error.message, "error");
                    } finally { setLoading(false); }
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-md bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-display text-xl font-bold uppercase text-white">Cadastro Completo</h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail *</label>
                                    <input name="email" value={formData.email} onChange={handleChange} type="email" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="seu@email.com" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Senha *</label>
                                    <input name="password" value={formData.password} onChange={handleChange} type="password" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="******" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo *</label>
                                    <input name="name" value={formData.name} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="Seu nome" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">WhatsApp / Celular *</label>
                                    <input name="phone" value={formData.phone} onChange={handleChange} type="tel" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="(11) 99999-9999" />
                                </div>
                                <div className="flex gap-4">
                                    <div className="w-1/3"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">CEP</label><input name="cep" value={formData.cep} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="00000-000" /></div>
                                    <div className="flex-1"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Bairro</label><input name="neighborhood" value={formData.neighborhood} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="Bairro" /></div>
                                </div>
                                <div className="flex gap-4">
                                    <div className="flex-1"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Rua</label><input name="street" value={formData.street} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="Nome da rua" /></div>
                                    <div className="w-1/4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">N¬∫</label><input name="number" value={formData.number} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="123" /></div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Complemento</label>
                                    <input name="complement" value={formData.complement} onChange={handleChange} type="text" className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="Apto, Bloco, Ponto de refer√™ncia" />
                                </div>
                            </div>
                            <button onClick={handleSubmit} disabled={loading} className="w-full bg-[#B11226] text-white font-bold uppercase py-4 rounded mt-6 hover:bg-red-700 transition-colors disabled:opacity-50">{loading ? 'Salvando...' : 'Criar Conta'}</button>
                        </div>
                    </div>
                );
            };

            const NewReviewModal = ({ onClose, onSubmit }) => {
                const [name, setName] = useState('');
                const [text, setText] = useState('');
                const [stars, setStars] = useState(5);

                const handleSubmit = () => {
                    if (!name || !text) { addToast("Preencha todos os campos.", "error"); return; }
                    onSubmit({ name, text, stars });
                    onClose();
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-sm bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-display text-xl font-bold uppercase text-white">Avaliar</h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Seu Nome</label>
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none" placeholder="Nome" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nota</label>
                                    <div className="flex gap-2">
                                        {[1, 2, 3, 4, 5].map(s => (
                                            <button key={s} onClick={() => setStars(s)} className={`text-2xl transition-transform hover:scale-110 ${s <= stars ? 'text-[#B11226]' : 'text-gray-700'}`}>‚òÖ</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Coment√°rio</label>
                                    <textarea value={text} onChange={(e) => setText(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none h-24 resize-none" placeholder="Conte sua experi√™ncia..." />
                                </div>
                                <button onClick={handleSubmit} className="w-full bg-[#B11226] text-white font-bold uppercase py-3 rounded hover:bg-red-700 transition-colors">Enviar Avalia√ß√£o</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ComboModal = ({ product, products, categories, onClose, onAdd }) => {
                const [selectedDrink, setSelectedDrink] = useState('');
                const [addFries, setAddFries] = useState(false);
                const [doneness, setDoneness] = useState(product.doneness || 'Ao Ponto');
                
                // Busca din√¢mica da categoria Bebidas pelo nome (independente do ID)
                const drinksCategory = categories?.find(c => c.name.toLowerCase() === 'bebidas');
                const drinksId = drinksCategory ? drinksCategory.id : 999;
                const drinks = products.filter(p => p.category_id === drinksId && p.available);
                const fries = products.find(p => p.name.includes("Batata"));

                const handleConfirm = (e) => {
                    let finalPrice = product.price;
                    let descriptionParts = [];
                    
                    if (addFries && fries) {
                        finalPrice += (fries.price * 0.85); // 15% de desconto na batata
                        descriptionParts.push("Batata (Combo)");
                    }
                    
                    if (selectedDrink) {
                        const drink = drinks.find(d => d.id == selectedDrink);
                        if (drink) {
                            finalPrice += drink.price; // Pre√ßo normal ou desconto se quiser
                            descriptionParts.push(`${drink.name}`);
                        }
                    }
                    
                    const comboItem = {
                        id: `combo-${product.id}-${Date.now()}`, // ID √∫nico para n√£o agrupar errado
                        name: `Combo ${product.name}`,
                        price: finalPrice,
                        description: descriptionParts.length > 0 ? `Com: ${descriptionParts.join(" + ")}` : product.description,
                        doneness: product.has_doneness ? doneness : null,
                        available: true
                    };
                    
                    if (e) triggerConfetti(e);
                    onAdd(comboItem);
                    onClose();
                };

                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-sm bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                            <h3 className="font-display text-xl font-bold uppercase text-white mb-2">Turbine seu pedido!</h3>
                            <p className="text-gray-400 text-sm mb-6">Voc√™ selecionou: <span className="text-white font-bold">{product.name}</span></p>
                            
                            <div className="space-y-4 mb-6">
                                {product.has_doneness && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Ponto da Carne</label>
                                        <div className="flex gap-2">
                                            {['Mal Passado', 'Ao Ponto', 'Bem Passado'].map(p => (
                                                <button key={p} onClick={() => setDoneness(p)} className={`flex-1 py-2 text-[10px] font-bold uppercase rounded border transition-colors ${doneness === p ? 'bg-white text-black border-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}>{p}</button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {fries && (
                                    <label className="flex items-center justify-between p-3 border border-gray-700 rounded cursor-pointer hover:bg-[#0B0B0B]">
                                        <div className="flex items-center gap-3">
                                            <input type="checkbox" checked={addFries} onChange={(e) => setAddFries(e.target.checked)} className="accent-[#B11226] w-5 h-5" />
                                            <div className="flex flex-col">
                                                <span className="font-bold text-sm text-white">Adicionar {fries.name}</span>
                                                <span className="text-xs text-green-400">De R$ {fries.price.toFixed(2)} por R$ {(fries.price * 0.85).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </label>
                                )}
                                
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Escolha a Bebida</label>
                                    <select value={selectedDrink} onChange={(e) => setSelectedDrink(e.target.value)} className="w-full bg-[#0B0B0B] border border-gray-700 rounded p-3 text-white focus:border-[#B11226] outline-none">
                                        <option value="">Sem bebida</option>
                                        {drinks.map(d => (
                                            <option key={d.id} value={d.id}>{d.name} (+ R$ {d.price.toFixed(2)})</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={(e) => { triggerConfetti(e); onAdd({ ...product, doneness: product.has_doneness ? doneness : null }); onClose(); }} className="flex-1 bg-transparent border border-gray-700 text-gray-300 font-bold text-xs uppercase py-3 rounded hover:bg-gray-800">Apenas o Lanche</button>
                                <button onClick={(e) => handleConfirm(e)} className="flex-1 bg-[#B11226] text-white font-bold text-xs uppercase py-3 rounded hover:bg-red-700">Adicionar Combo</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const TermsModal = ({ onClose }) => (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-display text-xl font-bold uppercase text-white">Termos de Uso</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div className="space-y-4 text-gray-300 text-sm leading-relaxed font-sans">
                            <p>Bem-vindo ao Na Garagem! Ao utilizar nosso sistema de pedidos, voc√™ concorda com os termos abaixo:</p>
                            
                            <div className="bg-[#B11226]/10 border border-[#B11226]/30 p-4 rounded-lg my-4">
                                <h4 className="font-bold text-[#B11226] uppercase mb-1 flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    Aviso Importante
                                </h4>
                                <p className="text-white font-bold">As imagens dos produtos exibidas neste site s√£o meramente ilustrativas.</p>
                                <p className="text-xs mt-1 text-gray-400">Os produtos reais podem apresentar varia√ß√µes de montagem, cor, tamanho ou apresenta√ß√£o, dependendo da disponibilidade de ingredientes frescos e do processo artesanal de preparo.</p>
                            </div>

                            <h4 className="font-bold text-white uppercase mt-4">1. Pedidos e Disponibilidade</h4>
                            <p>Todos os pedidos est√£o sujeitos √† confirma√ß√£o e disponibilidade de estoque. Reservamo-nos o direito de cancelar pedidos em caso de inconsist√™ncias, falta de insumos ou problemas t√©cnicos.</p>

                            <h4 className="font-bold text-white uppercase mt-4">2. Pre√ßos e Pagamento</h4>
                            <p>Os pre√ßos podem sofrer altera√ß√µes sem aviso pr√©vio. O valor final a ser pago √© aquele apresentado no momento da confirma√ß√£o do pedido no carrinho de compras.</p>

                            <h4 className="font-bold text-white uppercase mt-4">3. Entregas e Retiradas</h4>
                            <p>O tempo de entrega informado √© uma estimativa e pode variar conforme a demanda da cozinha, condi√ß√µes clim√°ticas e de tr√¢nsito. Para retiradas, aguarde a confirma√ß√£o de que o pedido est√° pronto.</p>
                        </div>
                        <div className="mt-6 pt-4 border-t border-gray-800 text-center">
                            <button onClick={onClose} className="bg-[#B11226] text-white font-bold uppercase py-3 px-8 rounded hover:bg-red-700 transition-colors w-full md:w-auto">Li e Concordo</button>
                        </div>
                    </div>
                </div>
            );

            const PrivacyModal = ({ onClose }) => (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-[#1F1F1F] rounded-xl p-6 border border-gray-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-display text-xl font-bold uppercase text-white">Pol√≠tica de Privacidade</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div className="space-y-4 text-gray-300 text-sm leading-relaxed font-sans">
                            <p>A sua privacidade √© importante para o Na Garagem. Esta pol√≠tica explica como coletamos, usamos e protegemos seus dados.</p>
                            
                            <h4 className="font-bold text-white uppercase mt-4">1. Coleta de Dados</h4>
                            <p>Coletamos apenas as informa√ß√µes necess√°rias para processar seu pedido e oferecer nosso programa de fidelidade:</p>
                            <ul className="list-disc pl-5 space-y-1 text-gray-400">
                                <li>Nome completo</li>
                                <li>N√∫mero de telefone (WhatsApp)</li>
                                <li>Endere√ßo de entrega</li>
                                <li>Hist√≥rico de pedidos</li>
                            </ul>

                            <h4 className="font-bold text-white uppercase mt-4">2. Uso das Informa√ß√µes</h4>
                            <p>Seus dados s√£o utilizados exclusivamente para:</p>
                            <ul className="list-disc pl-5 space-y-1 text-gray-400">
                                <li>Preparar e entregar seus pedidos.</li>
                                <li>Enviar atualiza√ß√µes sobre o status do pedido via WhatsApp.</li>
                                <li>Gerenciar seus pontos no Programa de Fidelidade.</li>
                                <li>Melhorar nosso atendimento e servi√ßos.</li>
                            </ul>

                            <h4 className="font-bold text-white uppercase mt-4">3. Compartilhamento</h4>
                            <p>N√£o vendemos nem compartilhamos seus dados pessoais com terceiros para fins de marketing. Seus dados podem ser compartilhados apenas com entregadores parceiros para a realiza√ß√£o da entrega.</p>

                            <h4 className="font-bold text-white uppercase mt-4">4. Seguran√ßa</h4>
                            <p>Adotamos medidas de seguran√ßa para proteger seus dados contra acesso n√£o autorizado. As informa√ß√µes s√£o armazenadas em banco de dados seguro.</p>

                            <h4 className="font-bold text-white uppercase mt-4">5. Seus Direitos</h4>
                            <p>Voc√™ tem o direito de solicitar a visualiza√ß√£o, corre√ß√£o ou exclus√£o dos seus dados pessoais a qualquer momento. Para isso, entre em contato conosco pelo WhatsApp.</p>
                        </div>
                        <div className="mt-6 pt-4 border-t border-gray-800 text-center">
                            <button onClick={onClose} className="bg-[#B11226] text-white font-bold uppercase py-3 px-8 rounded hover:bg-red-700 transition-colors w-full md:w-auto">Entendi</button>
                        </div>
                    </div>
                </div>
            );

            // Listener para abrir modal de indica√ß√£o via evento
            useEffect(() => {
                const handleOpenReferral = () => setShowReferralModal(true);
                window.addEventListener('openReferral', handleOpenReferral);
                return () => window.removeEventListener('openReferral', handleOpenReferral);
            }, []);

            const Footer = () => (
                <footer className="bg-[#050505] border-t border-gray-800 pt-6 mt-6">
                    <div className="max-w-4xl mx-auto px-4">
                        {/* Se√ß√£o de Avalia√ß√µes */}
                        <div className="mb-6 border-b border-gray-800 pb-6">
                            <div className="flex flex-col items-center mb-8">
                                <h3 className="font-display text-xl font-bold uppercase text-white text-center flex items-center justify-center gap-2 mb-2">
                                    <span className="text-[#B11226]">‚òÖ</span> O que dizem da Garagem
                                </h3>
                                <button onClick={() => setShowReviewModal(true)} className="text-xs text-[#B11226] border border-[#B11226] px-3 py-1 rounded uppercase font-bold hover:bg-[#B11226] hover:text-white transition-colors">Escrever Avalia√ß√£o</button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {reviews.map((review) => (
                                    <div key={review.id} className="bg-[#1F1F1F] p-6 rounded-lg border border-gray-800 relative flex flex-col h-full">
                                        <div className="text-[#B11226] text-lg mb-2">{"‚òÖ".repeat(review.stars)}</div>
                                        <p className="text-gray-300 text-sm italic mb-4 flex-grow">"{review.text}"</p>
                                        <p className="text-white font-bold text-xs uppercase mb-2">- {review.name}</p>
                                        {review.reply && (
                                            <div className="mt-3 pt-3 border-t border-gray-700 bg-[#151515] -mx-6 -mb-6 p-4 rounded-b-lg">
                                                <p className="text-[#B11226] text-[10px] font-bold uppercase mb-1 flex items-center gap-1">üí¨ Resposta da Garagem:</p>
                                                <p className="text-gray-400 text-xs">"{review.reply}"</p>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="text-center pb-6">
                        <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/logo%20na%20garagem%20sem%20fundo%20(2).png" className="w-24 h-24 object-contain mx-auto mb-4 opacity-80" alt="Logo" />
                        <h3 className="font-display text-2xl font-bold uppercase text-white mb-6">Na Garagem</h3>
                        
                        <div className="flex justify-center gap-8 mb-8">
                            <a href="https://www.instagram.com/nagaragemburg/" target="_blank" className="text-gray-400 hover:text-[#B11226] transition-colors transform hover:scale-110">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                            </a>
                        </div>

                        <div className="text-gray-500 text-sm mb-8 space-y-1">
                            <p className="font-bold uppercase text-gray-400 mb-2 tracking-wider">Hor√°rio de Funcionamento</p>
                            <p>Ter√ßa a Domingo</p>
                            <p className="text-white font-bold">19:00 √†s 23:00</p>
                        </div>

                        <div className="flex flex-col items-center gap-4">
                            <p className="text-gray-800 text-xs uppercase tracking-widest">¬© {new Date().getFullYear()} Na Garagem Burguer</p>
                        </div>
                        <div className="text-center mt-2 flex justify-center gap-4">
                            <button onClick={() => setShowTermsModal(true)} className="text-[10px] text-gray-600 hover:text-gray-400 underline uppercase">Termos de Uso</button>
                            <button onClick={() => setShowPrivacyModal(true)} className="text-[10px] text-gray-600 hover:text-gray-400 underline uppercase">Pol√≠tica de Privacidade</button>
                        </div>
                        <div className="text-center mt-4 text-gray-600 text-xs">
                            <p>(14) 3737-1017</p>
                            <p>Rua Coronel Joaquim Piza, N¬∞ 536, Gar√ßa-SP</p>
                        </div>
                        </div>
                    </div>
                </footer>
            );

            return (
                <div className="min-h-screen bg-transparent text-[#F5F5F5] font-sans pb-20">
                    {/* --- HEADER / NAVEGA√á√ÉO --- */}
                    <div className="sticky top-0 z-50 bg-[#0B0B0B] border-b border-white/10 shadow-2xl transition-all duration-300">
                        <div className="max-w-6xl mx-auto w-full">
                            {/* Linha Principal: Logo e Login */}
                            <div className="flex items-center justify-between px-4 py-4">
                                {/* Menu Hamb√∫rguer (Mobile) */}
                                <button className="md:hidden p-2 text-white mr-2" onClick={() => setIsMobileMenuOpen(true)}>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                                </button>

                                {/* Esquerda: Logo */}
                                <div className="flex items-center gap-3 cursor-pointer" onClick={() => { setView('client'); window.scrollTo({ top: 0, behavior: 'smooth' }); setSearchTerm(''); }}>
                                    <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/logos/logo%20na%20garagem%20sem%20fundo%20(2).png" className="w-12 h-12 object-contain drop-shadow-lg" alt="Logo" />
                                    <div className="flex flex-col">
                                        <h1 className="font-display text-2xl font-bold text-[#B11226] uppercase tracking-wider leading-none">Na Garagem</h1>
                                    </div>
                                </div>

                                {/* Direita: Bot√£o Entrar / Usu√°rio */}
                                <button 
                                    onClick={() => !user ? setAuthMode('login') : null}
                                    className="flex items-center gap-2 px-4 py-2 rounded-full border border-white/20 text-white hover:bg-white/10 transition-colors group"
                                >
                                    {user ? (
                                        <>
                                            <div className="w-6 h-6 bg-[#B11226] rounded-full flex items-center justify-center text-[10px] font-bold">
                                                {getUserInitial(user)}
                                            </div>
                                            <span className="text-sm font-bold uppercase hidden md:inline">{getUserDisplayName(user).split(' ')[0]}</span>
                                            <span onClick={(e) => { e.stopPropagation(); setUser(null); localStorage.removeItem('garage_session'); }} className="ml-2 text-gray-500 hover:text-red-500" title="Sair">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                            </span>
                                        </>
                                    ) : (
                                        <>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                            <span className="text-sm font-bold uppercase">Entrar</span>
                                        </>
                                    )}
                                </button>
                            </div>
                            
                            {/* Bot√£o Repetir Pedido (Apenas Logado) */}
                            {user && (
                                <div className="px-4 pb-2 flex justify-end">
                                    <button onClick={handleRepeatLastOrder} className="text-[10px] font-bold uppercase text-[#B11226] border border-[#B11226] px-3 py-1 rounded hover:bg-[#B11226] hover:text-white transition-colors flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Repetir √öltimo Pedido</button>
                                </div>
                            )}

                            {/* Linha Secund√°ria: Categorias */}
                            {view === 'client' && (
                                <div className="hidden md:block w-full px-4 pb-4">
                                    <div className="flex gap-2 items-center flex-wrap justify-center md:justify-start">
                                        {categories.slice(0, 8).map(cat => (
                                            <a key={cat.id} href={`#cat-${cat.id}`} onClick={() => setActiveCategory(cat.id)} className={`flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider border transition-all duration-300 whitespace-nowrap ${activeCategory === cat.id ? 'bg-[#B11226] text-white border-[#B11226]' : 'bg-transparent text-gray-400 border-gray-800 hover:border-gray-600 hover:text-white'}`}>
                                                {cat.name}
                                            </a>
                                        ))}
                                        
                                        {categories.length > 8 && (
                                            <div className="relative">
                                                <button onClick={(e) => { e.stopPropagation(); setIsCategoryDropdownOpen(!isCategoryDropdownOpen); }} className={`px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider border border-gray-800 bg-transparent text-gray-400 hover:text-white flex items-center gap-1 ${isCategoryDropdownOpen ? 'bg-gray-800 text-white' : ''}`}>
                                                    Ver Mais <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M6 9l6 6 6-6"/></svg>
                                                </button>
                                                {isCategoryDropdownOpen && (
                                                    <>
                                                        <div className="fixed inset-0 z-40" onClick={() => setIsCategoryDropdownOpen(false)}></div>
                                                        <div className="absolute top-full left-0 mt-2 w-48 bg-[#1F1F1F] border border-gray-800 rounded-xl shadow-2xl z-50 overflow-hidden animate-fade-in">
                                                            {categories.slice(8).map(cat => (
                                                                <a key={cat.id} href={`#cat-${cat.id}`} onClick={() => { setActiveCategory(cat.id); setIsCategoryDropdownOpen(false); }} className={`block px-4 py-3 text-xs font-bold uppercase hover:bg-[#B11226] hover:text-white transition-colors border-b border-gray-800 last:border-0 ${activeCategory === cat.id ? 'text-[#B11226] bg-black/20' : 'text-gray-400'}`}>{cat.name}</a>
                                                            ))}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Menu Mobile (Drawer) */}
                        {isMobileMenuOpen && (
                            <div className="fixed inset-0 z-[60] flex justify-start">
                                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsMobileMenuOpen(false)}></div>
                                <div className="relative w-64 bg-[#1F1F1F] h-full shadow-2xl flex flex-col border-r border-gray-800 animate-slideInLeft">
                                    <div className="p-6 border-b border-gray-800 flex justify-between items-center">
                                        <h2 className="font-display text-xl font-bold uppercase text-white">Categorias</h2>
                                        <button onClick={() => setIsMobileMenuOpen(false)} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                        {categories.map(cat => (
                                            <a key={cat.id} href={`#cat-${cat.id}`} onClick={() => { setActiveCategory(cat.id); setIsMobileMenuOpen(false); }} className={`block px-4 py-3 rounded-lg text-sm font-bold uppercase transition-colors ${activeCategory === cat.id ? 'bg-[#B11226] text-white' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                                {cat.name}
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modais de Autentica√ß√£o e Contexto */}
                        {authMode === 'login' && <LoginModal onClose={() => setAuthMode(null)} onLogin={(u) => { setUser(u); setAuthMode(null); }} onCreateAccount={() => setAuthMode('register')} onForgotPassword={() => setAuthMode('forgotPassword')} />}
                        {authMode === 'register' && <RegistrationModal onClose={() => setAuthMode(null)} onSave={(u) => { setUser(u); setAuthMode(null); }} />}
                        {authMode === 'forgotPassword' && <ForgotPasswordModal onClose={() => setAuthMode(null)} onBack={() => setAuthMode('login')} />}
                        {showReviewModal && <NewReviewModal onClose={() => setShowReviewModal(false)} onSubmit={handleAddReview} />}
                        {showComboModal && comboProduct && <ComboModal product={comboProduct} products={products} categories={categories} onClose={() => setShowComboModal(false)} onAdd={addToCart} />}
                        {showReferralModal && <ReferralModal user={user} onClose={() => setShowReferralModal(false)} onAddPoints={handleAddPoints} />}
                        {viewProduct && <ProductDetailsModal product={viewProduct} onClose={() => setViewProduct(null)} onAdd={handleProductClick} />}
                        {showHistoryModal && <OrderHistoryModal history={orderHistory} onClose={() => setShowHistoryModal(false)} onRepeat={handleRepeatOrder} />}
                        {showNewsletter && <NewsletterBanner onClose={handleCloseNewsletter} onRegister={handleRegisterNewsletter} />}
                        {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} />}
                        {showPrivacyModal && <PrivacyModal onClose={() => setShowPrivacyModal(false)} />}
                    </div>

                    {/* --- CONTE√öDO PRINCIPAL --- */}
                    <main className="max-w-4xl mx-auto p-4">
                        {view === 'client' && (
                            <div className="space-y-8 animate-fade-in">
                                {/* Hero e Promo√ß√µes (Componentes simples podem ficar aqui ou serem extra√≠dos tamb√©m) */}
                                <div className="relative w-full h-64 md:h-96 bg-gray-900 mb-8 overflow-hidden md:rounded-b-3xl shadow-2xl group z-0">
                                    {/* Banner Desktop (Aparece em telas m√©dias e grandes) */}
                                    <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/fundos/desktop.jpg" className="hidden md:block w-full h-full object-cover opacity-100" alt="Hero Desktop" />
                                    {/* Banner Mobile (Aparece apenas em celulares) - Substitua o src abaixo pela imagem vertical */}
                                    <img src="https://zgeyjrmnkisomdlugupm.supabase.co/storage/v1/object/public/fundos/celular%20(1).jpg" className="block md:hidden w-full h-full object-cover opacity-100" alt="Hero Mobile" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-[#121212] via-black/20 to-transparent"></div><div className="absolute bottom-0 left-0 w-full p-8 md:p-12"><div className="max-w-4xl mx-auto"><span className="text-[#B11226] font-bold text-xs md:text-sm uppercase tracking-[0.2em] mb-3 block bg-black/60 w-fit px-3 py-1 rounded-full backdrop-blur-md border border-white/10">Artesanal & Raiz</span><h2 className="font-display text-4xl md:text-6xl font-bold text-white uppercase leading-none drop-shadow-2xl tracking-wide">Na Garagem</h2><p className="text-gray-200 text-xs md:text-base mt-3 max-w-lg drop-shadow font-sans font-medium">O verdadeiro sabor do hamb√∫rguer feito na brasa. Sem frescura.</p></div></div></div>
                                
                                {promotions.length > 0 && <div className="mb-8 animate-fade-in"><div className="grid gap-4">{promotions.map(promo => (<div key={promo.id} className="bg-gradient-to-r from-[#B11226] to-[#800e1b] p-6 rounded-2xl shadow-lg flex flex-col md:flex-row items-center justify-between text-white relative overflow-hidden"><div className="absolute -right-10 -top-10 text-white/10"><svg width="150" height="150" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></div><div className="relative z-10"><h3 className="font-display text-2xl font-bold uppercase mb-1">{promo.title}</h3><p className="text-white/90 text-sm max-w-md">{promo.description}</p></div><div className="relative z-10 mt-4 md:mt-0 bg-white text-[#B11226] px-4 py-2 rounded-xl font-bold text-xl shadow-lg transform rotate-2">{promo.discount_percentage}% OFF</div></div>))}</div></div>}

                                <div className="relative mb-6 flex gap-3">
                                    <div className="relative flex-1">
                                        <input 
                                            type="text" 
                                            placeholder="Buscar lanche..." 
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full bg-[#1F1F1F] border border-gray-800 rounded p-4 pl-12 text-white focus:border-[#B11226] outline-none shadow-lg"
                                        />
                                        <svg className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                    </div>
                                    <button 
                                        onClick={() => setShowFavoritesOnly(!showFavoritesOnly)}
                                        className={`px-4 rounded border font-bold uppercase text-xs transition-colors flex flex-col items-center justify-center gap-1 ${showFavoritesOnly ? 'bg-[#B11226] border-[#B11226] text-white' : 'border-gray-800 bg-[#1F1F1F] text-gray-400 hover:text-white'}`}
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill={showFavoritesOnly ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                        Favoritos
                                    </button>
                                    <button 
                                        onClick={() => setShowHistoryModal(true)}
                                        className="px-4 rounded border border-gray-800 bg-[#1F1F1F] text-gray-400 hover:text-white font-bold uppercase text-xs transition-colors flex flex-col items-center justify-center gap-1"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                                        Pedidos
                                    </button>
                                </div>

                                {/* Cart√£o de Fidelidade */}
                                {user && <LoyaltyCard user={user} onRedeem={handleRedeemPoints} />}

                                {/* Carrossel de Destaques */}
                                {!searchTerm && !showFavoritesOnly && <FeaturedCarousel products={products} onAdd={handleProductClick} />}

                                {categories.map(cat => {
                                    const catProducts = products.filter(p => 
                                        Number(p.category_id) === Number(cat.id) && 
                                        p.available !== false && // Aceita null/undefined como true
                                        p.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
                                        (!showFavoritesOnly || favorites.includes(p.id))
                                    );

                                    if (!catProducts.length) return null;

                                    return (
                                        <div key={cat.id} id={`cat-${cat.id}`} className="scroll-mt-80 md:scroll-mt-48">
                                            <h2 className="font-display text-2xl font-bold uppercase mb-6 border-l-4 border-[#B11226] pl-4 tracking-widest text-white">{cat.name}</h2>
                                            {/* TAREFA A: Grid 2 colunas mobile, 3 colunas desktop (md+) */}
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-6">
                                                {catProducts.map(p => (
                                                    <ProductCard 
                                                        key={p.id} 
                                                        product={p} 
                                                        isFavorite={favorites.includes(p.id)}
                                                        onToggleFavorite={toggleFavorite}
                                                        onAdd={handleProductClick}
                                                        onView={setViewProduct}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    <Footer />

                    {/* --- CARRINHO (SIDEBAR) --- */}
                    {isCartOpen && (
                        // TAREFA: Refatora√ß√£o do Modal Carrinho (Mobile First + Safe Area)
                        <>
                            {/* Overlay (z-60 para cobrir bot√µes flutuantes z-50) */}
                            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm" onClick={() => setIsCartOpen(false)}></div>
                            
                            {/* Modal Container */}
                            <div className="fixed inset-0 z-[70] flex items-end sm:items-center justify-center pointer-events-none">
                                <div className="pointer-events-auto w-full sm:w-[560px] max-h-[90dvh] bg-[#1F1F1F] shadow-2xl flex flex-col border border-gray-800 rounded-t-2xl sm:rounded-2xl overflow-hidden">
                                {/* Header Sticky */}
                                <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0B0B0B] sticky top-0 z-20">
                                    <h2 className="font-display text-xl font-bold uppercase text-white">Seu Pedido</h2>
                                    <button onClick={() => setIsCartOpen(false)} className="text-gray-400 hover:text-white text-2xl">&times;</button>
                                </div>
                                
                                {/* Conte√∫do com Scroll */}
                                <div className="flex-1 overflow-y-auto p-4 bg-[#1F1F1F]">
                                    <div className="space-y-6">
                                        {/* 1. Lista de Itens */}
                                        <section className="space-y-4">
                                            {cart.length === 0 ? <p className="text-center text-gray-500 mt-10">Carrinho vazio.</p> : cart.map(item => (
                                        <div key={item.id} className="bg-[#0B0B0B] p-3 border border-gray-800 flex flex-col gap-3">
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <h4 className="font-bold text-sm uppercase">{item.name}</h4>
                                                    <p className="text-[#B11226] text-sm">R$ {(item.price * item.quantity).toFixed(2)}</p>
                                                    {item.variant_label && <span className="text-[10px] text-white block bg-[#B11226]/50 px-1 rounded w-fit mt-1">{item.variant_label}</span>}
                                                    {item.doneness && <span className="text-[10px] text-gray-400 block bg-gray-800 px-1 rounded w-fit mt-1">Ponto: {item.doneness}</span>}
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <div className="flex items-center border border-gray-700 rounded">
                                                        <button onClick={() => updateQuantity(item.id, -1)} className="px-2 py-1 hover:bg-gray-800">-</button>
                                                        <span className="px-2 text-sm">{item.quantity}</span>
                                                        <button onClick={() => updateQuantity(item.id, 1)} className="px-2 py-1 hover:bg-gray-800">+</button>
                                                    </div>
                                                    <button onClick={() => removeFromCart(item.id)} className="text-gray-500 hover:text-red-500 p-1" title="Remover"><IconTrash /></button>
                                                </div>
                                            </div>
                                            <input 
                                                type="text" 
                                                placeholder="Observa√ß√µes (ex: sem cebola)" 
                                                value={item.observation || ''} 
                                                onChange={(e) => updateObservation(item.id, e.target.value)}
                                                className="w-full bg-[#151515] text-gray-300 text-xs p-2 rounded border border-gray-800 focus:border-[#B11226] focus:outline-none"
                                            />
                                        </div>
                                            ))}
                                        </section>

                                        {cart.length > 0 && (
                                            <>
                                                <hr className="border-gray-800" />

                                                {/* 2. Dados de Entrega */}
                                                <section className="space-y-4">
                                                    <h3 className="font-bold text-sm uppercase text-gray-400 flex items-center gap-2"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> Dados de Entrega</h3>
                                        
                                        <div className="flex gap-2 mb-2">
                                            <button 
                                                onClick={() => setDeliveryMethod('delivery')}
                                                disabled={storeSettings.status === 'pickup_only'}
                                                className={`flex-1 py-2 text-xs font-bold uppercase rounded border transition-colors ${deliveryMethod === 'delivery' ? 'bg-[#B11226] border-[#B11226] text-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'} ${storeSettings.status === 'pickup_only' ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                Entrega
                                            </button>
                                            <button 
                                                onClick={() => setDeliveryMethod('pickup')}
                                                className={`flex-1 py-2 text-xs font-bold uppercase rounded border transition-colors ${deliveryMethod === 'pickup' ? 'bg-[#B11226] border-[#B11226] text-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}
                                            >
                                                Retirada
                                            </button>
                                        </div>

                                        <input 
                                            type="text" 
                                            placeholder="Seu Nome" 
                                            value={customerName}
                                            onChange={(e) => setCustomerName(e.target.value)}
                                            className="w-full bg-[#0B0B0B] text-white p-3 rounded border border-gray-700 focus:border-[#B11226] focus:outline-none text-sm"
                                        />
                                        {deliveryMethod === 'delivery' && (
                                            <div className="space-y-2">
                                                {/* (B) Seletor de Endere√ßo */}
                                                {user && savedAddress && (
                                                    <div className="flex gap-2 mb-2">
                                                        <button 
                                                            onClick={() => { setUseNewAddress(false); setCustomerAddress(savedAddress); }}
                                                            className={`flex-1 py-2 text-[10px] font-bold uppercase rounded border ${!useNewAddress ? 'bg-white text-black border-white' : 'border-gray-700 text-gray-400'}`}
                                                        >
                                                            Usar Salvo
                                                        </button>
                                                        <button 
                                                            onClick={() => { setUseNewAddress(true); setCustomerAddress(''); }}
                                                            className={`flex-1 py-2 text-[10px] font-bold uppercase rounded border ${useNewAddress ? 'bg-white text-black border-white' : 'border-gray-700 text-gray-400'}`}
                                                        >
                                                            Novo Endere√ßo
                                                        </button>
                                                    </div>
                                                )}
                                                <textarea 
                                                    placeholder="Endere√ßo Completo (Rua, N√∫mero, Bairro...)" 
                                                    value={customerAddress}
                                                    onChange={(e) => setCustomerAddress(e.target.value)}
                                                    className="w-full bg-[#0B0B0B] text-white p-3 rounded border border-gray-700 focus:border-[#B11226] focus:outline-none text-sm h-20 resize-none"
                                                />
                                            </div>
                                        )}
                                                </section>

                                                <hr className="border-gray-800" />

                                                {/* 3. Forma de Pagamento */}
                                                <section className="space-y-4">
                                                    <h3 className="font-bold text-sm uppercase text-gray-400 flex items-center gap-2"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg> Pagamento</h3>
                                        <div className="flex gap-2">
                                            {['pix', 'card', 'money'].map(method => (
                                                <button 
                                                    key={method}
                                                    onClick={() => setPaymentMethod(method)}
                                                    className={`flex-1 py-2 text-xs font-bold uppercase rounded border transition-colors ${paymentMethod === method ? 'bg-[#B11226] border-[#B11226] text-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}
                                                >
                                                    {{ pix: 'Pix', card: 'Cart√£o', money: 'Dinheiro' }[method]}
                                                </button>
                                            ))}
                                        </div>
                                        {paymentMethod === 'money' && (
                                            <input 
                                                type="text" 
                                                placeholder="Troco para quanto? (ex: 50,00)" 
                                                value={changeFor}
                                                onChange={(e) => setChangeFor(e.target.value)}
                                                className="w-full bg-[#0B0B0B] text-white p-3 rounded border border-gray-700 focus:border-[#B11226] focus:outline-none text-sm mt-2"
                                            />
                                        )}
                                                </section>
                                
                                                <hr className="border-gray-800" />

                                                {/* 4. Cupom */}
                                                <section className="space-y-4">
                                                    <label className="text-xs font-bold text-gray-500 uppercase block">Cupom de Desconto</label>
                                        <div className="flex gap-2">
                                            <input type="text" value={couponCode} onChange={(e) => setCouponCode(e.target.value)} placeholder="C√≥digo" className="flex-1 bg-[#151515] border border-gray-800 rounded p-2 text-white text-sm uppercase focus:border-[#B11226] outline-none" />
                                            <button onClick={applyCoupon} className="bg-gray-800 text-white px-3 rounded font-bold text-xs hover:bg-gray-700">APLICAR</button>
                                        </div>
                                                </section>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* Footer Sticky */}
                                <div className="p-4 bg-[#0B0B0B] border-t border-gray-800 sticky bottom-0 z-20 pb-[max(1rem,env(safe-area-inset-bottom))]">
                                    <div className="flex justify-between text-sm text-gray-400 mb-1"><span>Subtotal:</span> <span>R$ {subTotal.toFixed(2)}</span></div>
                                    {discountPercent > 0 && <div className="flex justify-between text-sm text-green-500 mb-2"><span>Desconto:</span> <span>- R$ {discountValue.toFixed(2)}</span></div>}
                                    <div className="flex justify-between text-xl font-bold mb-4"><span>Total:</span> <span className="text-[#B11226]">R$ {cartTotal.toFixed(2)}</span></div>
                                    <button onClick={checkoutWhatsApp} disabled={!cart.length} className="w-full bg-[#25D366] text-white font-bold uppercase py-4 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed">Finalizar no WhatsApp</button>
                                </div>
                            </div>
                            </div>
                        </>
                    )}

                    {/* --- BOT√ÉO FLUTUANTE --- */}
                    {view === 'client' && <button onClick={() => setIsCartOpen(true)} className="fixed bottom-6 right-6 z-40 bg-[#B11226] text-white p-4 rounded-full shadow-lg hover:scale-110 transition-transform">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                        {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-white text-[#B11226] font-bold text-xs w-6 h-6 flex items-center justify-center rounded-full border-2 border-black">{cart.reduce((a,b)=>a+b.quantity,0)}</span>}
                    </button>}

                    {/* --- BOT√ÉO WHATSAPP FLUTUANTE --- */}
                    <a
                        href="https://wa.me/5514998946607?text=Ol%C3%A1%2C%20gostaria%20de%20fazer%20um%20pedido%21"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="fixed bottom-6 left-6 z-50 bg-[#25D366] text-white p-4 rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center"
                        title="Fale conosco no WhatsApp"
                    >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </a>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ToastProvider><App /></ToastProvider>);
    </script>
</body>
</html>
